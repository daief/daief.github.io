<!DOCTYPE html>
<html  data-head-attrs="">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>学写一个乞丐版 Vue | daief的个人日志</title><meta property="og:title" content="学写一个乞丐版 Vue | daief的个人日志"><meta property="author" content="daief"><meta name="head:count" content="2">
<script>window.__INITIAL_STATE__={"global":{"site":{"postCount":51,"tagCount":42,"categoryCount":16,"site_pv":0,"page_pv":0,"site_uv":0},"indexPostPagination":{"current":1,"pageSize":10,"totalPages":0,"result":[]},"postDetail":{"post":{"id":"build-a-poor-vue","slug":"post/build-a-poor-vue","path":"/post/build-a-poor-vue","title":"学写一个乞丐版 Vue","comments":true,"published":true,"date":"2020-04-02T13:03:54.000Z","updated":"","tags":[{"id":"2d8ec58babcec05d3fe8f712968de749","name":"Vue","postCount":5,"postIds":[]}],"categories":[{"id":"9abfe4a03928eb88a75a5cd95822dfef","name":"前端","slug":"categories/前端","path":"/categories/前端","parentId":"","postCount":36,"postIds":[]},{"id":"2d8ec58babcec05d3fe8f712968de749","name":"Vue","slug":"categories/Vue","path":"/categories/Vue","parentId":"9abfe4a03928eb88a75a5cd95822dfef","postCount":1,"postIds":[]}],"excerpt":"<p><del>没有钱了，肯定要学啊，不学没有钱用。</del></p>\n<p><del>看源码是不可能看的，这辈子不可能看的。写东西又不会写，就是看这种东西，才能维持得了生活这样子。</del></p>\n<p><del>什么 Github、掘金、知乎上面个个都是人才，说话又好听，技术又厉害，超喜欢在上面逛的。</del></p>\n","more":"\n\n<h2 id=\"前言（<del>废话</del>）\">前言（<del>废话</del>）<a name=\"前言（<del>废话</del>）\" class=\"headerlink\" href=\"#前言（<del>废话</del>）\"></a></h2><p>对 Vue（v2.x） 的原理也不能说不知道吧，但又解释不太清楚，试着学写一个乞丐版的 Vue 来加深一下理解，同时也想作为后续阅读源码的一个事前准备。老实说这里的内容基本都是参考别人的，但为了回顾以及加深印象，还是再以文章的形式记录一下好了。</p>\n<p>在线 DEMO：<a href=\"https://codesandbox.io/s/mock-vue-0otdk?fontsize=14&amp;hidenavigation=1&amp;theme=dark\">Edit On CodeSandbox.</a></p>\n<p>既然叫作乞丐版，那么自然要有该有的样子：</p>\n<ul>\n<li>实现基本是按照参考资料以及自己的理解来着；</li>\n<li>尤其是指令、事件绑定那里，自己瞎写写的；</li>\n<li>实现了：<ul>\n<li>在模板中使用 <code>{{variable}}</code> 并绑定值，支持表达式，但一个节点还只能有一个双大括号插值</li>\n<li>v-model 指令</li>\n<li>v-show、@click 指令，支持表达式</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"编码实现\">编码实现<a name=\"编码实现\" class=\"headerlink\" href=\"#编码实现\"></a></h2><p>为了方便编码和阅读，全都用了 <code>class</code> 的写法。</p>\n<p>简易的 Vue 由以下几个部分组成：</p>\n<pre class=\"hljs language-text\" hljs-language=\"text\"><code style=\"display:block;\">Vue\n├── index.ts\n├── Compile.ts\n├── Dep.ts\n├── Watcher.ts\n├── observe.ts\n└── utils.ts</code></pre><h3 id=\"index\">index<a name=\"index\" class=\"headerlink\" href=\"#index\"></a></h3><p>定义一个 Vue 的类，像下面这样，保持用法上的一致：</p>\n<pre class=\"hljs language-ts\" hljs-language=\"ts\"><code style=\"display:block;\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">Vue</span> {\n  <span class=\"hljs-attr\">$el</span>: <span class=\"hljs-title class_\">HTMLElement</span>;\n  <span class=\"hljs-attr\">$data</span>: <span class=\"hljs-built_in\">any</span>;\n  methods;\n\n  <span class=\"hljs-title function_\">constructor</span>(<span class=\"hljs-params\">opts: IOption</span>) {\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">$el</span> = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">querySelector</span>(opts.<span class=\"hljs-property\">el</span>);\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">$data</span> = opts.<span class=\"hljs-property\">data</span>;\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">methods</span> = opts.<span class=\"hljs-property\">methods</span> || {};\n\n    <span class=\"hljs-comment\">// 使 data 变成响应式</span>\n    <span class=\"hljs-title function_\">observe</span>(<span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">$data</span>);\n    <span class=\"hljs-comment\">// 使得直接在 Vue 实例上读/写属性时能直接读/写到 $data、methods 中相应的字段</span>\n    <span class=\"hljs-title function_\">proxy</span>(<span class=\"hljs-variable language_\">this</span>);\n    <span class=\"hljs-comment\">// 解析 DOM 模板并进行渲染</span>\n    <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Compile</span>(<span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">$el</span>, <span class=\"hljs-variable language_\">this</span>);\n  }\n}\n\n<span class=\"hljs-comment\">// 使用</span>\n<span class=\"hljs-keyword\">const</span> vm = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Vue</span>({\n  <span class=\"hljs-attr\">el</span>: <span class=\"hljs-string\">&#x27;#app&#x27;</span>,\n  <span class=\"hljs-attr\">data</span>: {\n    <span class=\"hljs-attr\">text</span>: <span class=\"hljs-number\">1</span>,\n  },\n  <span class=\"hljs-attr\">methods</span>: {\n    <span class=\"hljs-comment\">// ...</span>\n  },\n});\n\nvm.<span class=\"hljs-property\">text</span>;\n<span class=\"hljs-comment\">// 等价于</span>\nvm.<span class=\"hljs-property\">$data</span>.<span class=\"hljs-property\">text</span>;</code></pre><h3 id=\"observe\">observe<a name=\"observe\" class=\"headerlink\" href=\"#observe\"></a></h3><p><code>observe</code> 模块将 <code>data</code> 转换成响应式的对象，使用了 <code>Object.defineProperty</code>, 通过 <code>set</code>，<code>get</code> 来设置值与获取值。</p>\n<blockquote>\n<p><code>Dep</code> 是观察者模式的应用。</p>\n</blockquote>\n<p>在这里同时借助观察者模式当值发生改变的时候将发出 <code>notify</code> 进行通知。</p>\n<pre class=\"hljs language-ts\" hljs-language=\"ts\"><code style=\"display:block;\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">observe</span>(<span class=\"hljs-params\">data: Record&lt;<span class=\"hljs-built_in\">string</span>, <span class=\"hljs-built_in\">any</span>&gt;</span>) {\n  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> k <span class=\"hljs-keyword\">in</span> data) {\n    <span class=\"hljs-title function_\">defineReactive</span>(data, k, data[k]);\n  }\n}\n\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">defineReactive</span>(<span class=\"hljs-params\">obj, key, value</span>) {\n  <span class=\"hljs-keyword\">const</span> dep = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Dep</span>();\n  <span class=\"hljs-title class_\">Object</span>.<span class=\"hljs-title function_\">defineProperty</span>(obj, key, {\n    <span class=\"hljs-title function_\">get</span>(<span class=\"hljs-params\"></span>) {\n      <span class=\"hljs-title class_\">Dep</span>.<span class=\"hljs-property\">target</span> &amp;&amp; dep.<span class=\"hljs-title function_\">addSub</span>(<span class=\"hljs-title class_\">Dep</span>.<span class=\"hljs-property\">target</span>);\n      <span class=\"hljs-keyword\">return</span> value;\n    },\n    <span class=\"hljs-title function_\">set</span>(<span class=\"hljs-params\">newVal</span>) {\n      <span class=\"hljs-keyword\">if</span> (newVal === value) {\n        <span class=\"hljs-keyword\">return</span>;\n      }\n      value = newVal;\n      dep.<span class=\"hljs-title function_\">notify</span>();\n    },\n  });\n}</code></pre><blockquote>\n<p>这里的 <code>Dep.target &amp;&amp; dep.addSub(Dep.target)</code> 是 Vue 中设计比较精妙的一部分，注意到这里是在 getter 中将 Watcher 加入订阅的。\n或者这么说，当 <code>Dep.target</code> 有值，这时候若发生取值操作（如，vm.text），<code>Dep.target</code> 就会被加入订阅。</p>\n</blockquote>\n<h3 id=\"utils\">utils<a name=\"utils\" class=\"headerlink\" href=\"#utils\"></a></h3><p><code>utils</code> 下其实就一个方法：<code>expressionToFunction</code>，它的作用可以看作是将一段字符串代码转换成一个函数，并且可以设置这个函数的上下文环境。</p>\n<pre class=\"hljs language-ts\" hljs-language=\"ts\"><code style=\"display:block;\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">expressionToFunction</span>(<span class=\"hljs-params\">exp, context</span>) {\n  <span class=\"hljs-comment\">// eslint-disable-next-line</span>\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Function</span>(<span class=\"hljs-string\">&#x27;with(this){return &#x27;</span> + exp + <span class=\"hljs-string\">&#x27;}&#x27;</span>).<span class=\"hljs-title function_\">bind</span>(context);\n}</code></pre><p>举个例子：</p>\n<pre class=\"hljs language-ts\" hljs-language=\"ts\"><code style=\"display:block;\"><span class=\"hljs-comment\">// 有一个表达式</span>\n<span class=\"hljs-keyword\">const</span> expression = <span class=\"hljs-string\">`&#x27;hello &#x27; + name`</span>;\n\n<span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-property\">name</span> = <span class=\"hljs-string\">&#x27;windowName&#x27;</span>;\n\n<span class=\"hljs-keyword\">const</span> ctx = {\n  <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">&#x27;ctxName&#x27;</span>,\n};\n\n<span class=\"hljs-title function_\">expressionToFunction</span>(expression, <span class=\"hljs-variable language_\">window</span>)(); <span class=\"hljs-comment\">// &#x27;hello windowName&#x27;</span>\n\n<span class=\"hljs-title function_\">expressionToFunction</span>(expression, ctx)(); <span class=\"hljs-comment\">// &#x27;hello ctxName&#x27;</span></code></pre><h3 id=\"Compile\">Compile<a name=\"Compile\" class=\"headerlink\" href=\"#Compile\"></a></h3><p><code>Compile</code> 来解析模板并渲染，对应的理解与说明以注释的形式标注在代码块中了。</p>\n<p>总得来说，根据所给的 DOM 的节点开始向下遍历，逐一进行双括号语法的解析、视图与值的绑定以及指令的相关处理。</p>\n<pre class=\"hljs language-ts\" hljs-language=\"ts\"><code style=\"display:block;\"><span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">Watcher</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;./Watcher&#x27;</span>;\n<span class=\"hljs-keyword\">import</span> { expressionToFunction } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;./utils&#x27;</span>;\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">Compile</span> {\n  _vm = <span class=\"hljs-literal\">null</span>;\n\n  <span class=\"hljs-title function_\">constructor</span>(<span class=\"hljs-params\">node: HTMLElement, vm: <span class=\"hljs-built_in\">any</span></span>) {\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">_vm</span> = vm;\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">walkChildren</span>(node);\n  }\n\n  <span class=\"hljs-comment\">/**\n   * 遍历节点，进行解析、绑定、指令的处理\n   */</span>\n  walkChildren = <span class=\"hljs-function\"><span class=\"hljs-params\">el</span> =&gt;</span> {\n    [].<span class=\"hljs-property\">slice</span>.<span class=\"hljs-title function_\">call</span>(el.<span class=\"hljs-property\">childNodes</span>).<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">n</span> =&gt;</span> {\n      <span class=\"hljs-keyword\">const</span> { nodeType } = n;\n      <span class=\"hljs-comment\">// 节点类型为text</span>\n      <span class=\"hljs-keyword\">if</span> (nodeType === <span class=\"hljs-number\">3</span>) {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">compileElement</span>(n);\n      }\n      <span class=\"hljs-comment\">// 注释类型，先不管</span>\n      <span class=\"hljs-keyword\">if</span> (nodeType === <span class=\"hljs-number\">8</span>) {\n        <span class=\"hljs-keyword\">return</span>;\n      }\n      <span class=\"hljs-comment\">// 元素类型</span>\n      <span class=\"hljs-keyword\">if</span> (nodeType === <span class=\"hljs-number\">1</span>) {\n        <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">parseDirective</span>(n);\n      }\n      <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">walkChildren</span>(n);\n    });\n  };\n\n  <span class=\"hljs-comment\">/**\n   * 文本节点类型，解析双花括号语法，并响应值（data）的变化以进行更新\n   */</span>\n  <span class=\"hljs-title function_\">compileElement</span>(<span class=\"hljs-params\">node</span>) {\n    <span class=\"hljs-keyword\">const</span> reg = <span class=\"hljs-regexp\">/\\{\\{(.*)\\}\\}/</span>;\n    <span class=\"hljs-keyword\">const</span> { nodeValue } = node;\n\n    <span class=\"hljs-keyword\">if</span> (!reg.<span class=\"hljs-title function_\">test</span>(nodeValue)) {\n      <span class=\"hljs-keyword\">return</span>;\n    }\n\n    <span class=\"hljs-comment\">// 获取双花括号中匹配到的字符串，即表达式</span>\n    <span class=\"hljs-keyword\">const</span> expression = <span class=\"hljs-title class_\">RegExp</span>.<span class=\"hljs-property\">$1</span>;\n\n    <span class=\"hljs-comment\">// 然后对这个表达式实例化一个 Watcher 对象，实现了将 `这个表达式` 与 `表达式中涉及的值` 绑定的操作</span>\n    <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Watcher</span>(<span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">_vm</span>, expression, <span class=\"hljs-function\">(<span class=\"hljs-params\">newV, oldV</span>) =&gt;</span> {\n      <span class=\"hljs-comment\">/**\n       * 当 `初始化` 以及 `表达式的值变化` 时，这个回调会被触发\n       * 在这里，将 DOM 上的值进行更新\n       * 即根据正则将双花括号的内容替换成最终的值\n       */</span>\n\n      <span class=\"hljs-comment\">// 一些特殊字符需要转义处理</span>\n      <span class=\"hljs-keyword\">const</span> regExpression = expression.<span class=\"hljs-title function_\">replace</span>(<span class=\"hljs-regexp\">/\\+|\\?|\\(|\\)/g</span>, <span class=\"hljs-function\"><span class=\"hljs-params\">_</span> =&gt;</span> <span class=\"hljs-string\">&#x27;\\\\&#x27;</span> + _);\n\n      <span class=\"hljs-keyword\">const</span> replaceReg = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">RegExp</span>(<span class=\"hljs-string\">&#x27;{{\\\\s*&#x27;</span> + regExpression + <span class=\"hljs-string\">&#x27;\\\\s*}}&#x27;</span>);\n      node.<span class=\"hljs-property\">nodeValue</span> = nodeValue.<span class=\"hljs-title function_\">replace</span>(replaceReg, newV);\n    });\n  }\n\n  <span class=\"hljs-comment\">/**\n   * 指令的处理（大概\n   */</span>\n  <span class=\"hljs-title function_\">parseDirective</span>(<span class=\"hljs-params\">node</span>) {\n    <span class=\"hljs-keyword\">const</span> { attributes } = node;\n\n    [].<span class=\"hljs-property\">slice</span>.<span class=\"hljs-title function_\">call</span>(attributes || []).<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">attr</span> =&gt;</span> {\n      <span class=\"hljs-comment\">/**\n       * 指令的处理是读取 DOM 上的 attributes 进行逐个解析\n       * 值同样要作为表达式进行处理\n       */</span>\n      <span class=\"hljs-keyword\">const</span> { nodeName, nodeValue } = attr;\n      <span class=\"hljs-keyword\">const</span> expression = nodeValue;\n\n      <span class=\"hljs-keyword\">if</span> (nodeName === <span class=\"hljs-string\">&#x27;v-model&#x27;</span>) {\n        <span class=\"hljs-comment\">/**\n         * 这里简单实现了一下 v-model\n         * 监听原生 input 事件，值变化时改变 vm （Vue 实例）上相应的值\n         * 同时建立一个 Watcher，当值变化时，改变节点的 value\n         * 从而实现了双向绑定的语法糖\n         */</span>\n        node.<span class=\"hljs-title function_\">addEventListener</span>(<span class=\"hljs-string\">&#x27;input&#x27;</span>, <span class=\"hljs-function\"><span class=\"hljs-params\">e</span> =&gt;</span> {\n          <span class=\"hljs-comment\">// 给相应的 data 属性赋值，进而触发该属性的 set 方法</span>\n          <span class=\"hljs-comment\">// 触发 set vm[name]</span>\n          <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">_vm</span>[nodeValue] = e.<span class=\"hljs-property\">target</span>.<span class=\"hljs-property\">value</span>;\n        });\n\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Watcher</span>(<span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">_vm</span>, nodeValue, <span class=\"hljs-function\"><span class=\"hljs-params\">val</span> =&gt;</span> {\n          node.<span class=\"hljs-property\">value</span> = val || <span class=\"hljs-string\">&#x27;&#x27;</span>;\n        });\n      } <span class=\"hljs-comment\">// v-model</span>\n    });\n  }\n}</code></pre><h3 id=\"Watcher\">Watcher<a name=\"Watcher\" class=\"headerlink\" href=\"#Watcher\"></a></h3><p>从上一部分也可以大致看出，<code>Watcher</code> 能够实现对一个表达式的监听，当表达式的值发生变化时触发相应的回调。然后这是 <code>Watcher</code> 的具体实现：</p>\n<pre class=\"hljs language-ts\" hljs-language=\"ts\"><code style=\"display:block;\"><span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">Dep</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;./Dep&#x27;</span>;\n<span class=\"hljs-keyword\">import</span> { expressionToFunction } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;./utils&#x27;</span>;\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">Watcher</span> {\n  vm;\n  <span class=\"hljs-attr\">expression</span>: <span class=\"hljs-built_in\">string</span>;\n  value = <span class=\"hljs-literal\">null</span>;\n  cb;\n  getValue;\n\n  <span class=\"hljs-title function_\">constructor</span>(<span class=\"hljs-params\">vm, expression, cb?</span>) {\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">vm</span> = vm;\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">expression</span> = expression;\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cb</span> = cb;\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">getValue</span> = <span class=\"hljs-title function_\">expressionToFunction</span>(expression, vm);\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">value</span> = <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">getValue</span>();\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">update</span>();\n  }\n\n  <span class=\"hljs-title function_\">update</span>(<span class=\"hljs-params\"></span>) {\n    <span class=\"hljs-keyword\">const</span> oldValue = <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">value</span>;\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">get</span>();\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cb</span> &amp;&amp; <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">cb</span>(<span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">value</span>, oldValue);\n  }\n\n  <span class=\"hljs-comment\">// 获取 data 的属性值</span>\n  <span class=\"hljs-title function_\">get</span>(<span class=\"hljs-params\"></span>) {\n    <span class=\"hljs-title class_\">Dep</span>.<span class=\"hljs-property\">target</span> = <span class=\"hljs-variable language_\">this</span>;\n    <span class=\"hljs-comment\">// 触发相应属性的 get</span>\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">value</span> = <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">getValue</span>();\n    <span class=\"hljs-title class_\">Dep</span>.<span class=\"hljs-property\">target</span> = <span class=\"hljs-literal\">null</span>;\n  }\n}</code></pre><p><code>getValue</code> 是一个方法，用来获取 <code>表达式的值</code>，注意这个属性是通过 <code>expressionToFunction(expression, vm)</code> 得到的，并且这个方法的上下文是 Vue 实例。</p>\n<p>比如说，在模板中有这样的一段：<code>&lt;div&gt;{% raw %}{{text % 2 === 0 ? 1 : 2}}{% endraw %}&lt;/div&gt;</code>；在 <code>Compile</code> 中解析后的 <code>expression</code> 是这样的 <code>&#39;text % 2 === 0 ? 1 : 2&#39;</code>，经过 <code>expressionToFunction(expression, vm)</code> 处理得到的 <code>getValue</code> 可以认为是这样的：</p>\n<pre class=\"hljs language-ts\" hljs-language=\"ts\"><code style=\"display:block;\"><span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">getValue</span> = <span class=\"hljs-function\">() =&gt;</span> {\n  <span class=\"hljs-keyword\">return</span> vm.<span class=\"hljs-property\">text</span> % <span class=\"hljs-number\">2</span> === <span class=\"hljs-number\">0</span> ? <span class=\"hljs-number\">1</span> : <span class=\"hljs-number\">2</span>;\n};</code></pre><p>从而调用 <code>getValue</code> 的时候就能获取到对应表达式的值。</p>\n<p><code>update</code> 方法当接收到 <code>Dep</code> 的通知时会被调用。</p>\n<p>最后就是 <code>get</code> 方法，十分简短：</p>\n<pre class=\"hljs language-ts\" hljs-language=\"ts\"><code style=\"display:block;\"><span class=\"hljs-title class_\">Dep</span>.<span class=\"hljs-property\">target</span> = <span class=\"hljs-variable language_\">this</span>;\n<span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">value</span> = <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">getValue</span>();\n<span class=\"hljs-title class_\">Dep</span>.<span class=\"hljs-property\">target</span> = <span class=\"hljs-literal\">null</span>;</code></pre><p>此处与 <code>observe</code> 一节中就关联上了，<code>Dep.target</code> 实际上作为一个全局属性用来临时地传值，只是将其设置成了 <code>Dep</code> 的静态属性而已。<code>get</code> 方法就三个步骤：</p>\n<ul>\n<li>将自身 <code>Watcher</code> 实例赋值给 <code>Dep.target</code>，通过这一点达到目的同时借助了 JavaScript 单线程运行的特点；</li>\n<li>使用 <code>this.getValue()</code> 计算表达式值，结合前面的理解，当这一过程中涉及 <code>vm.xxx</code> 的操作时，<strong>当前 Watcher 将会被加入订阅</strong>；</li>\n<li>释放 <code>Dep.target</code>；</li>\n</ul>\n<h3 id=\"Dep\">Dep<a name=\"Dep\" class=\"headerlink\" href=\"#Dep\"></a></h3><p>这是一个简单的观察者模式的实现，写得很简单了，调用 <code>notify</code> 时将会通知到所有的订阅者。</p>\n<pre class=\"hljs language-ts\" hljs-language=\"ts\"><code style=\"display:block;\"><span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">Watcher</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;./Watcher&#x27;</span>;\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">Dep</span> {\n  <span class=\"hljs-keyword\">static</span> <span class=\"hljs-attr\">target</span>: <span class=\"hljs-title class_\">Watcher</span> | <span class=\"hljs-literal\">null</span> = <span class=\"hljs-literal\">null</span>;\n\n  <span class=\"hljs-attr\">subs</span>: <span class=\"hljs-title class_\">Set</span>&lt;<span class=\"hljs-title class_\">Watcher</span>&gt; = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Set</span>();\n\n  <span class=\"hljs-title function_\">addSub</span>(<span class=\"hljs-params\">sub: Watcher</span>) {\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">subs</span>.<span class=\"hljs-title function_\">add</span>(sub);\n  }\n\n  <span class=\"hljs-title function_\">notify</span>(<span class=\"hljs-params\"></span>) {\n    <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">subs</span>.<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">sub</span> =&gt;</span> {\n      sub.<span class=\"hljs-title function_\">update</span>();\n    });\n  }\n}</code></pre><h3 id=\"使用\">使用<a name=\"使用\" class=\"headerlink\" href=\"#使用\"></a></h3><p>至此，乞丐版 Vue 的实现大体就完成了，接着就可以假装是一个真正的 Vue 了。</p>\n<pre class=\"hljs language-html\" hljs-language=\"html\"><code style=\"display:block;\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;app&quot;</span>&gt;</span>\n  hello {% raw %}{{ text }}{% endraw %}\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">br</span> /&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">v-modle</span>=<span class=\"hljs-string\">&quot;text&quot;</span> /&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></code></pre><pre class=\"hljs language-ts\" hljs-language=\"ts\"><code style=\"display:block;\"><span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">Vue</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;./Vue&#x27;</span>;\n\n<span class=\"hljs-keyword\">const</span> vm = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Vue</span>({\n  <span class=\"hljs-attr\">el</span>: <span class=\"hljs-string\">&#x27;#app&#x27;</span>,\n  <span class=\"hljs-attr\">data</span>: {\n    <span class=\"hljs-attr\">text</span>: <span class=\"hljs-string\">&#x27;world&#x27;</span>,\n  },\n});\n\nvm.<span class=\"hljs-property\">text</span>; <span class=\"hljs-comment\">// world</span>\nvm.<span class=\"hljs-property\">text</span> = <span class=\"hljs-string\">&#x27;Vue&#x27;</span>;\nvm.<span class=\"hljs-property\">text</span>; <span class=\"hljs-comment\">//</span></code></pre><h2 id=\"结语\">结语<a name=\"结语\" class=\"headerlink\" href=\"#结语\"></a></h2><p>可能都知道 Vue 2 是通过 <code>Object.defineProperty</code> 实现的，但稍微具体一点的细节我其实是不清楚的，这样一次简易的实现过程，让我的认知提高了不少。</p>\n<p>都说这个挺简单的，但一开始看的时候却并不容易看明白，之后自己照着写了一遍才有了一点感觉，还是要多多实践。</p>\n<hr>\n<p>参考资料：</p>\n<ul>\n<li><a href=\"https://juejin.im/post/5c2202b75188250850606d9c\">实现一个简易的 Vue</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/29629337\">100 行代码实现一个迷你 Vue</a></li>\n</ul>\n","hash":"c761fb966e40f6a6bbc0e4ed3f58a5a1","isArticle":true,"sort":0,"filename":"","raw":"","prev":{"id":"hexo-custom-code-highlight-by-prismjs","slug":"post/hexo-custom-code-highlight-by-prismjs","path":"/post/hexo-custom-code-highlight-by-prismjs","title":"使用 prismjs 自定义 Hexo 代码高亮","comments":true,"published":true,"date":"2020-03-23T16:50:24.000Z","updated":"","tags":[{"id":"be8df1f28c0abc85a0ed0c6860e5d832","name":"Blog","postCount":3,"postIds":[]},{"id":"c00d1eb68b529768ba98c975c76a9b66","name":"Hexo","postCount":1,"postIds":[]}],"categories":[{"id":"9abfe4a03928eb88a75a5cd95822dfef","name":"前端","slug":"categories/前端","path":"/categories/前端","parentId":"","postCount":36,"postIds":[]},{"id":"c00d1eb68b529768ba98c975c76a9b66","name":"Hexo","slug":"categories/Hexo","path":"/categories/Hexo","parentId":"9abfe4a03928eb88a75a5cd95822dfef","postCount":1,"postIds":[]}],"excerpt":"<p>一直就想优化一下 Hexo 的代码高亮部分来着，对 <code>ts</code>、<code>tsx</code> 部分的支持一直不太好；也许直接更新 Next 就能直接解决，但博客部分已经魔改了不少，本着这个原则就继续魔改下去好了。</p>\n<blockquote>\n<p>本站是在 Next 5 的基础上建成的，不过本文内容与 Next 5 的关系不大</p>\n</blockquote>\n","more":"","hash":"5cb61feaa8a607c534c6e7936c2bb437","isArticle":true,"sort":0,"filename":"","raw":"","prev":null,"next":null,"tocHtml":""},"next":{"id":"site-engine-gugu","slug":"post/site-engine-gugu","path":"/post/site-engine-gugu","title":"博客框架 —— gugu","comments":true,"published":true,"date":"2021-07-25T22:18:00.000Z","updated":"","tags":[{"id":"be8df1f28c0abc85a0ed0c6860e5d832","name":"Blog","postCount":3,"postIds":[]},{"id":"1d9db1ebcf1c30ffc9485e981aec4f04","name":"Vite","postCount":1,"postIds":[]},{"id":"79dcf464d3e1b41635e194883d0c939a","name":"Vue3","postCount":1,"postIds":[]}],"categories":[{"id":"9abfe4a03928eb88a75a5cd95822dfef","name":"前端","slug":"categories/前端","path":"/categories/前端","parentId":"","postCount":36,"postIds":[]}],"excerpt":"<p>很久之就一直想把博客改成单页的，而中间发生了不少咕咕咕（<del>懂得都懂，不懂的我也不用再说了 🐶</del>）的事情，别说改造了，连文都没更新。在咕了大半年之后，终于完成了大改造，将原来使用的 <a href=\"https://hexo.io/\">Hexo</a> 替换成了个人实现的博客框架 <a href=\"https://github.com/daief/blog/tree/master/packages/gugu\">gugu</a>。</p>\n","more":"","hash":"a8a32cd67619054f427012f0acc946d0","isArticle":true,"sort":0,"filename":"","raw":"","prev":null,"next":null,"tocHtml":""}}},"tocHtml":"","simplePages":[{"id":"41a3cc43f8af362b82fbe2aa97817528","slug":"resume","path":"/resume"},{"id":"fabb5629b694584be9ff314ab8187577","slug":"resume-v2","path":"/resume-v2"},{"id":"34787f8e18c76ce0f4c3cc680ab728ef","slug":"resume-v1","path":"/resume-v1"},{"id":"ac298b1fdf5a34ac83bb9376ccdde006","slug":"about","path":"/about"}],"simplePageDetail":{"post":null}},"labels":{"labels":[],"postPagination":{"current":1,"pageSize":10,"totalPages":0,"result":[]}}}</script>
    <script>
      if (/MSIE \d|Trident.*rv:/.test(navigator.userAgent)) {
        // redirect IE to Edge
        // This browser is no longer supported
        window.location.href = 'microsoft-edge:' + window.location.href;
        alert('请使用 Chrome/Edge/Firefox/Safari 等现代浏览器。');
        throw new Error('请使用 Chrome/Edge/Firefox/Safari 等现代浏览器。');
      }
    </script>
    <script type="module" crossorigin src="/assets/index.bf8c73c6.js"></script>
    <link rel="stylesheet" href="/assets/index.48ca4a1c.css">
  </head>
  <body  data-head-attrs="">
    <div id="app"><!--[--><div class="m-4 max-w-screen-xl flex flex-wrap md:m-6 xl:mx-auto md:flex-nowrap"><div class="w-full flex-shrink-0 self-start md:sticky md:top-6 md:w-48"><div class="blog-base-area-box py-6 mb-4"><img class="block w-24 h-24 rounded-full mx-auto" src="https://avatars.githubusercontent.com/u/19222089?v=4"><div class="mt-5 px-3 text-center"><h1 class="text-c-title font-normal"><a href="" class="unset">daief的个人日志</a></h1><p class="mt-2 text-sm text-c-secondary break-words">遇见你，遇见幸运💫</p><div class="mt-3 text-xs flex justify-center"><a href="/" class="unset"><svg class="if-icon" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-wenzhang" data-v-43154e2c></use></svg>(51) </a><span class="mx-1 text-c-secondary">|</span><a href="/tags" class="unset"><svg class="if-icon" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-tag" data-v-43154e2c></use></svg>(42) </a><span class="mx-1 text-c-secondary">|</span><a href="/categories" class="unset"><svg class="if-icon" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-category" data-v-43154e2c></use></svg>(16) </a></div><div class="mt-6 flex justify-center"><a to="https://github.com/daief" replace="false" href="https://github.com/daief" target="_blank" class="unset cursor-pointer"><!--[--><svg class="if-icon" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-github" data-v-43154e2c></use></svg><!--]--></a><span class="mx-2"></span><a to="mailto:defeng_mail@163.com" replace="false" href="mailto:defeng_mail@163.com" target="_blank" class="unset cursor-pointer"><!--[--><svg class="if-icon" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-email" data-v-43154e2c></use></svg><!--]--></a></div></div><div class="mt-6"><div class="text-center" data-v-73630894><!--[--><a href="/" class="unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link" data-v-73630894>首页</a><a href="/categories/" class="unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link" data-v-73630894>分类</a><a href="/tags/" class="unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link" data-v-73630894>标签</a><a href="/about/" class="unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link" data-v-73630894>关于</a><!--]--></div></div></div><div class="hidden md:block mt-2"><div class="footer text-center text-sm" data-v-8b3f10e8><div data-v-8b3f10e8><div data-v-8b3f10e8>© 2017-2025</div></div><div class="flex items-center justify-center" data-v-8b3f10e8>By <a href="https://github.com/daief/blog/tree/master/packages/gugu" target="_blank" data-v-8b3f10e8>gugu</a>  &amp; daief - <span class="picker-wrap" data-v-7aa3923e data-v-8b3f10e8><span data-v-7aa3923e></span></span></div><!----><!----><div data-v-8b3f10e8><a href="/sitemap.xml" target="_blank" data-v-8b3f10e8>站点地图</a></div></div></div></div><div class="w-full md:w-0 md:flex-grow md:mx-5"><div><!--[--><div class="blog-base-area-box px-4 py-8 md:px-8"><div><h1 class="text-2xl font-normal break-words">学写一个乞丐版 Vue</h1><div class="my-4 text-xs text-c-secondary"><div class="flex items-center flex-wrap"><!----><!----><div class="whitespace-nowrap"><svg class="if-icon text-c-secondary mx-1 text-c-secondary mx-1" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-calendar" data-v-43154e2c></use></svg>2020-04-02</div><!--[--><span class="mx-1">|</span><div class="whitespace-nowrap"><svg class="if-icon text-c-secondary mx-1 text-c-secondary mx-1" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-folder" data-v-43154e2c></use></svg><!--[--><!--[--><a href="/categories/前端" class="unset">前端</a><span>，</span><!--]--><!--[--><a href="/categories/Vue" class="unset">Vue</a><span></span><!--]--><!--]--></div><!--]--><!----></div></div><!-- content --><div class="markdown-body text-sm text-gray-800 leading-loose"><p><del>没有钱了，肯定要学啊，不学没有钱用。</del></p>
<p><del>看源码是不可能看的，这辈子不可能看的。写东西又不会写，就是看这种东西，才能维持得了生活这样子。</del></p>
<p><del>什么 Github、掘金、知乎上面个个都是人才，说话又好听，技术又厉害，超喜欢在上面逛的。</del></p>

<a id="more" class="h-0 mt-3 block"></a>


<h2 id="前言（<del>废话</del>）">前言（<del>废话</del>）<a name="前言（<del>废话</del>）" class="headerlink" href="#前言（<del>废话</del>）"></a></h2><p>对 Vue（v2.x） 的原理也不能说不知道吧，但又解释不太清楚，试着学写一个乞丐版的 Vue 来加深一下理解，同时也想作为后续阅读源码的一个事前准备。老实说这里的内容基本都是参考别人的，但为了回顾以及加深印象，还是再以文章的形式记录一下好了。</p>
<p>在线 DEMO：<a href="https://codesandbox.io/s/mock-vue-0otdk?fontsize=14&amp;hidenavigation=1&amp;theme=dark">Edit On CodeSandbox.</a></p>
<p>既然叫作乞丐版，那么自然要有该有的样子：</p>
<ul>
<li>实现基本是按照参考资料以及自己的理解来着；</li>
<li>尤其是指令、事件绑定那里，自己瞎写写的；</li>
<li>实现了：<ul>
<li>在模板中使用 <code>{{variable}}</code> 并绑定值，支持表达式，但一个节点还只能有一个双大括号插值</li>
<li>v-model 指令</li>
<li>v-show、@click 指令，支持表达式</li>
</ul>
</li>
</ul>
<h2 id="编码实现">编码实现<a name="编码实现" class="headerlink" href="#编码实现"></a></h2><p>为了方便编码和阅读，全都用了 <code>class</code> 的写法。</p>
<p>简易的 Vue 由以下几个部分组成：</p>
<pre class="hljs language-text" hljs-language="text"><code style="display:block;">Vue
├── index.ts
├── Compile.ts
├── Dep.ts
├── Watcher.ts
├── observe.ts
└── utils.ts</code></pre><h3 id="index">index<a name="index" class="headerlink" href="#index"></a></h3><p>定义一个 Vue 的类，像下面这样，保持用法上的一致：</p>
<pre class="hljs language-ts" hljs-language="ts"><code style="display:block;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Vue</span> {
  <span class="hljs-attr">$el</span>: <span class="hljs-title class_">HTMLElement</span>;
  <span class="hljs-attr">$data</span>: <span class="hljs-built_in">any</span>;
  methods;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts: IOption</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(opts.<span class="hljs-property">el</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$data</span> = opts.<span class="hljs-property">data</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">methods</span> = opts.<span class="hljs-property">methods</span> || {};

    <span class="hljs-comment">// 使 data 变成响应式</span>
    <span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$data</span>);
    <span class="hljs-comment">// 使得直接在 Vue 实例上读/写属性时能直接读/写到 $data、methods 中相应的字段</span>
    <span class="hljs-title function_">proxy</span>(<span class="hljs-variable language_">this</span>);
    <span class="hljs-comment">// 解析 DOM 模板并进行渲染</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Compile</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>, <span class="hljs-variable language_">this</span>);
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">text</span>: <span class="hljs-number">1</span>,
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-comment">// ...</span>
  },
});

vm.<span class="hljs-property">text</span>;
<span class="hljs-comment">// 等价于</span>
vm.<span class="hljs-property">$data</span>.<span class="hljs-property">text</span>;</code></pre><h3 id="observe">observe<a name="observe" class="headerlink" href="#observe"></a></h3><p><code>observe</code> 模块将 <code>data</code> 转换成响应式的对象，使用了 <code>Object.defineProperty</code>, 通过 <code>set</code>，<code>get</code> 来设置值与获取值。</p>
<blockquote>
<p><code>Dep</code> 是观察者模式的应用。</p>
</blockquote>
<p>在这里同时借助观察者模式当值发生改变的时候将发出 <code>notify</code> 进行通知。</p>
<pre class="hljs language-ts" hljs-language="ts"><code style="display:block;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">observe</span>(<span class="hljs-params">data: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k <span class="hljs-keyword">in</span> data) {
    <span class="hljs-title function_">defineReactive</span>(data, k, data[k]);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, value</span>) {
  <span class="hljs-keyword">const</span> dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>();
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params"></span>) {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> &amp;&amp; dep.<span class="hljs-title function_">addSub</span>(<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>);
      <span class="hljs-keyword">return</span> value;
    },
    <span class="hljs-title function_">set</span>(<span class="hljs-params">newVal</span>) {
      <span class="hljs-keyword">if</span> (newVal === value) {
        <span class="hljs-keyword">return</span>;
      }
      value = newVal;
      dep.<span class="hljs-title function_">notify</span>();
    },
  });
}</code></pre><blockquote>
<p>这里的 <code>Dep.target &amp;&amp; dep.addSub(Dep.target)</code> 是 Vue 中设计比较精妙的一部分，注意到这里是在 getter 中将 Watcher 加入订阅的。
或者这么说，当 <code>Dep.target</code> 有值，这时候若发生取值操作（如，vm.text），<code>Dep.target</code> 就会被加入订阅。</p>
</blockquote>
<h3 id="utils">utils<a name="utils" class="headerlink" href="#utils"></a></h3><p><code>utils</code> 下其实就一个方法：<code>expressionToFunction</code>，它的作用可以看作是将一段字符串代码转换成一个函数，并且可以设置这个函数的上下文环境。</p>
<pre class="hljs language-ts" hljs-language="ts"><code style="display:block;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">expressionToFunction</span>(<span class="hljs-params">exp, context</span>) {
  <span class="hljs-comment">// eslint-disable-next-line</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(<span class="hljs-string">&#x27;with(this){return &#x27;</span> + exp + <span class="hljs-string">&#x27;}&#x27;</span>).<span class="hljs-title function_">bind</span>(context);
}</code></pre><p>举个例子：</p>
<pre class="hljs language-ts" hljs-language="ts"><code style="display:block;"><span class="hljs-comment">// 有一个表达式</span>
<span class="hljs-keyword">const</span> expression = <span class="hljs-string">`&#x27;hello &#x27; + name`</span>;

<span class="hljs-variable language_">window</span>.<span class="hljs-property">name</span> = <span class="hljs-string">&#x27;windowName&#x27;</span>;

<span class="hljs-keyword">const</span> ctx = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;ctxName&#x27;</span>,
};

<span class="hljs-title function_">expressionToFunction</span>(expression, <span class="hljs-variable language_">window</span>)(); <span class="hljs-comment">// &#x27;hello windowName&#x27;</span>

<span class="hljs-title function_">expressionToFunction</span>(expression, ctx)(); <span class="hljs-comment">// &#x27;hello ctxName&#x27;</span></code></pre><h3 id="Compile">Compile<a name="Compile" class="headerlink" href="#Compile"></a></h3><p><code>Compile</code> 来解析模板并渲染，对应的理解与说明以注释的形式标注在代码块中了。</p>
<p>总得来说，根据所给的 DOM 的节点开始向下遍历，逐一进行双括号语法的解析、视图与值的绑定以及指令的相关处理。</p>
<pre class="hljs language-ts" hljs-language="ts"><code style="display:block;"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Watcher</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Watcher&#x27;</span>;
<span class="hljs-keyword">import</span> { expressionToFunction } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Compile</span> {
  _vm = <span class="hljs-literal">null</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">node: HTMLElement, vm: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_vm</span> = vm;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">walkChildren</span>(node);
  }

  <span class="hljs-comment">/**
   * 遍历节点，进行解析、绑定、指令的处理
   */</span>
  walkChildren = <span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
    [].<span class="hljs-property">slice</span>.<span class="hljs-title function_">call</span>(el.<span class="hljs-property">childNodes</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> { nodeType } = n;
      <span class="hljs-comment">// 节点类型为text</span>
      <span class="hljs-keyword">if</span> (nodeType === <span class="hljs-number">3</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compileElement</span>(n);
      }
      <span class="hljs-comment">// 注释类型，先不管</span>
      <span class="hljs-keyword">if</span> (nodeType === <span class="hljs-number">8</span>) {
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-comment">// 元素类型</span>
      <span class="hljs-keyword">if</span> (nodeType === <span class="hljs-number">1</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseDirective</span>(n);
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">walkChildren</span>(n);
    });
  };

  <span class="hljs-comment">/**
   * 文本节点类型，解析双花括号语法，并响应值（data）的变化以进行更新
   */</span>
  <span class="hljs-title function_">compileElement</span>(<span class="hljs-params">node</span>) {
    <span class="hljs-keyword">const</span> reg = <span class="hljs-regexp">/\{\{(.*)\}\}/</span>;
    <span class="hljs-keyword">const</span> { nodeValue } = node;

    <span class="hljs-keyword">if</span> (!reg.<span class="hljs-title function_">test</span>(nodeValue)) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 获取双花括号中匹配到的字符串，即表达式</span>
    <span class="hljs-keyword">const</span> expression = <span class="hljs-title class_">RegExp</span>.<span class="hljs-property">$1</span>;

    <span class="hljs-comment">// 然后对这个表达式实例化一个 Watcher 对象，实现了将 `这个表达式` 与 `表达式中涉及的值` 绑定的操作</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_vm</span>, expression, <span class="hljs-function">(<span class="hljs-params">newV, oldV</span>) =&gt;</span> {
      <span class="hljs-comment">/**
       * 当 `初始化` 以及 `表达式的值变化` 时，这个回调会被触发
       * 在这里，将 DOM 上的值进行更新
       * 即根据正则将双花括号的内容替换成最终的值
       */</span>

      <span class="hljs-comment">// 一些特殊字符需要转义处理</span>
      <span class="hljs-keyword">const</span> regExpression = expression.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\+|\?|\(|\)/g</span>, <span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> <span class="hljs-string">&#x27;\\&#x27;</span> + _);

      <span class="hljs-keyword">const</span> replaceReg = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">&#x27;{{\\s*&#x27;</span> + regExpression + <span class="hljs-string">&#x27;\\s*}}&#x27;</span>);
      node.<span class="hljs-property">nodeValue</span> = nodeValue.<span class="hljs-title function_">replace</span>(replaceReg, newV);
    });
  }

  <span class="hljs-comment">/**
   * 指令的处理（大概
   */</span>
  <span class="hljs-title function_">parseDirective</span>(<span class="hljs-params">node</span>) {
    <span class="hljs-keyword">const</span> { attributes } = node;

    [].<span class="hljs-property">slice</span>.<span class="hljs-title function_">call</span>(attributes || []).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">attr</span> =&gt;</span> {
      <span class="hljs-comment">/**
       * 指令的处理是读取 DOM 上的 attributes 进行逐个解析
       * 值同样要作为表达式进行处理
       */</span>
      <span class="hljs-keyword">const</span> { nodeName, nodeValue } = attr;
      <span class="hljs-keyword">const</span> expression = nodeValue;

      <span class="hljs-keyword">if</span> (nodeName === <span class="hljs-string">&#x27;v-model&#x27;</span>) {
        <span class="hljs-comment">/**
         * 这里简单实现了一下 v-model
         * 监听原生 input 事件，值变化时改变 vm （Vue 实例）上相应的值
         * 同时建立一个 Watcher，当值变化时，改变节点的 value
         * 从而实现了双向绑定的语法糖
         */</span>
        node.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;input&#x27;</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
          <span class="hljs-comment">// 给相应的 data 属性赋值，进而触发该属性的 set 方法</span>
          <span class="hljs-comment">// 触发 set vm[name]</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">_vm</span>[nodeValue] = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
        });

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_vm</span>, nodeValue, <span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> {
          node.<span class="hljs-property">value</span> = val || <span class="hljs-string">&#x27;&#x27;</span>;
        });
      } <span class="hljs-comment">// v-model</span>
    });
  }
}</code></pre><h3 id="Watcher">Watcher<a name="Watcher" class="headerlink" href="#Watcher"></a></h3><p>从上一部分也可以大致看出，<code>Watcher</code> 能够实现对一个表达式的监听，当表达式的值发生变化时触发相应的回调。然后这是 <code>Watcher</code> 的具体实现：</p>
<pre class="hljs language-ts" hljs-language="ts"><code style="display:block;"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Dep</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Dep&#x27;</span>;
<span class="hljs-keyword">import</span> { expressionToFunction } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Watcher</span> {
  vm;
  <span class="hljs-attr">expression</span>: <span class="hljs-built_in">string</span>;
  value = <span class="hljs-literal">null</span>;
  cb;
  getValue;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">vm, expression, cb?</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span> = vm;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">expression</span> = expression;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span> = cb;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">getValue</span> = <span class="hljs-title function_">expressionToFunction</span>(expression, vm);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getValue</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">update</span>();
  }

  <span class="hljs-title function_">update</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> oldValue = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cb</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>, oldValue);
  }

  <span class="hljs-comment">// 获取 data 的属性值</span>
  <span class="hljs-title function_">get</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-variable language_">this</span>;
    <span class="hljs-comment">// 触发相应属性的 get</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getValue</span>();
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>;
  }
}</code></pre><p><code>getValue</code> 是一个方法，用来获取 <code>表达式的值</code>，注意这个属性是通过 <code>expressionToFunction(expression, vm)</code> 得到的，并且这个方法的上下文是 Vue 实例。</p>
<p>比如说，在模板中有这样的一段：<code>&lt;div&gt;{% raw %}{{text % 2 === 0 ? 1 : 2}}{% endraw %}&lt;/div&gt;</code>；在 <code>Compile</code> 中解析后的 <code>expression</code> 是这样的 <code>&#39;text % 2 === 0 ? 1 : 2&#39;</code>，经过 <code>expressionToFunction(expression, vm)</code> 处理得到的 <code>getValue</code> 可以认为是这样的：</p>
<pre class="hljs language-ts" hljs-language="ts"><code style="display:block;"><span class="hljs-variable language_">this</span>.<span class="hljs-property">getValue</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> vm.<span class="hljs-property">text</span> % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">2</span>;
};</code></pre><p>从而调用 <code>getValue</code> 的时候就能获取到对应表达式的值。</p>
<p><code>update</code> 方法当接收到 <code>Dep</code> 的通知时会被调用。</p>
<p>最后就是 <code>get</code> 方法，十分简短：</p>
<pre class="hljs language-ts" hljs-language="ts"><code style="display:block;"><span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-variable language_">this</span>;
<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getValue</span>();
<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>;</code></pre><p>此处与 <code>observe</code> 一节中就关联上了，<code>Dep.target</code> 实际上作为一个全局属性用来临时地传值，只是将其设置成了 <code>Dep</code> 的静态属性而已。<code>get</code> 方法就三个步骤：</p>
<ul>
<li>将自身 <code>Watcher</code> 实例赋值给 <code>Dep.target</code>，通过这一点达到目的同时借助了 JavaScript 单线程运行的特点；</li>
<li>使用 <code>this.getValue()</code> 计算表达式值，结合前面的理解，当这一过程中涉及 <code>vm.xxx</code> 的操作时，<strong>当前 Watcher 将会被加入订阅</strong>；</li>
<li>释放 <code>Dep.target</code>；</li>
</ul>
<h3 id="Dep">Dep<a name="Dep" class="headerlink" href="#Dep"></a></h3><p>这是一个简单的观察者模式的实现，写得很简单了，调用 <code>notify</code> 时将会通知到所有的订阅者。</p>
<pre class="hljs language-ts" hljs-language="ts"><code style="display:block;"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Watcher</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Watcher&#x27;</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dep</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-attr">target</span>: <span class="hljs-title class_">Watcher</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-attr">subs</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">Watcher</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();

  <span class="hljs-title function_">addSub</span>(<span class="hljs-params">sub: Watcher</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">add</span>(sub);
  }

  <span class="hljs-title function_">notify</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">sub</span> =&gt;</span> {
      sub.<span class="hljs-title function_">update</span>();
    });
  }
}</code></pre><h3 id="使用">使用<a name="使用" class="headerlink" href="#使用"></a></h3><p>至此，乞丐版 Vue 的实现大体就完成了，接着就可以假装是一个真正的 Vue 了。</p>
<pre class="hljs language-html" hljs-language="html"><code style="display:block;"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app&quot;</span>&gt;</span>
  hello {% raw %}{{ text }}{% endraw %}
  <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-modle</span>=<span class="hljs-string">&quot;text&quot;</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></code></pre><pre class="hljs language-ts" hljs-language="ts"><code style="display:block;"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Vue</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Vue&#x27;</span>;

<span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;world&#x27;</span>,
  },
});

vm.<span class="hljs-property">text</span>; <span class="hljs-comment">// world</span>
vm.<span class="hljs-property">text</span> = <span class="hljs-string">&#x27;Vue&#x27;</span>;
vm.<span class="hljs-property">text</span>; <span class="hljs-comment">//</span></code></pre><h2 id="结语">结语<a name="结语" class="headerlink" href="#结语"></a></h2><p>可能都知道 Vue 2 是通过 <code>Object.defineProperty</code> 实现的，但稍微具体一点的细节我其实是不清楚的，这样一次简易的实现过程，让我的认知提高了不少。</p>
<p>都说这个挺简单的，但一开始看的时候却并不容易看明白，之后自己照着写了一遍才有了一点感觉，还是要多多实践。</p>
<hr>
<p>参考资料：</p>
<ul>
<li><a href="https://juejin.im/post/5c2202b75188250850606d9c">实现一个简易的 Vue</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/29629337">100 行代码实现一个迷你 Vue</a></li>
</ul>
</div><div class="mt-6 has-child mt-6 mt-6" data-v-3adb2250><!--[-->☘️<!--]--></div><div class="flex flex-wrap justify-center text-c-secondary text-sm mt-6"><!--[--><a href="/tags/Vue" class="unset block my-1 mx-2"><svg class="if-icon" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-tag" data-v-43154e2c></use></svg> Vue</a><!--]--></div></div></div><!-- 上下篇 --><div class="blog-base-area-box px-4 py-4 my-8 flex justify-between md:px-8"><!--[--><div class="pr-3 w-0 flex-grow break-words"><!--[--><div class="text-c-secondary text-xs mb-1">上一篇 </div><div class="text-sm"><a href="/post/hexo-custom-code-highlight-by-prismjs" class="unset">使用 prismjs 自定义 Hexo 代码高亮</a></div><!--]--></div><div class="text-right pl-3 w-0 flex-grow break-words"><!--[--><div class="text-c-secondary text-xs mb-1">下一篇 </div><div class="text-sm"><a href="/post/site-engine-gugu" class="unset">博客框架 —— gugu</a></div><!--]--></div><!--]--></div><!-- 评论 --><div id="comment" class="blog-base-area-box p-4 my-8 md:px-8"><h1 class="text-c-title text-xl block font-normal mb-5"><a href="#comment" class="unset text-c-title hover:text-c-title hover:underline"> 留言板 </a></h1><div class="utterances"></div></div><!--]--></div></div><div class="blog-base-area-box hidden md:block w-48 sticky top-6"><div style="display:none;" class="site-toc-wrap leading-6 break-all text-sm p-3"></div></div></div><div class="block mb-4 md:hidden"><div class="footer text-center text-sm" data-v-8b3f10e8><div data-v-8b3f10e8><div data-v-8b3f10e8>© 2017-2025</div></div><div class="flex items-center justify-center" data-v-8b3f10e8>By <a href="https://github.com/daief/blog/tree/master/packages/gugu" target="_blank" data-v-8b3f10e8>gugu</a>  &amp; daief - <span class="picker-wrap" data-v-7aa3923e data-v-8b3f10e8><span data-v-7aa3923e></span></span></div><!----><!----><div data-v-8b3f10e8><a href="/sitemap.xml" target="_blank" data-v-8b3f10e8>站点地图</a></div></div></div><div class="fixed z-100 right-8 bottom-14" data-v-49aec8bc><div class="blog-base-area-box action-btn opacity-0 pointer-events-none" data-v-49aec8bc><svg class="if-icon" aria-hidden="true" data-v-43154e2c data-v-49aec8bc><use xlink:href="#if-top" data-v-43154e2c></use></svg></div></div><!--]--></div>
    
  </body>
</html>
