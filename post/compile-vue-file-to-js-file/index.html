<!DOCTYPE html>
<html  data-head-attrs="">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>编译 Vue 单文件组件至 JS 文件 | daief的个人日志</title><meta property="og:title" content="编译 Vue 单文件组件至 JS 文件 | daief的个人日志"><meta property="author" content="daief"><meta name="head:count" content="2">
<script>window.__INITIAL_STATE__={"global":{"site":{"postCount":51,"tagCount":42,"categoryCount":16,"site_pv":0,"page_pv":0,"site_uv":0},"indexPostPagination":{"current":1,"pageSize":10,"totalPages":0,"result":[]},"postDetail":{"post":{"id":"compile-vue-file-to-js-file","slug":"post/compile-vue-file-to-js-file","path":"/post/compile-vue-file-to-js-file","title":"编译 Vue 单文件组件至 JS 文件","comments":true,"published":true,"date":"2019-11-28T17:34:26.000Z","updated":"","tags":[{"id":"2d8ec58babcec05d3fe8f712968de749","name":"Vue","postCount":5,"postIds":[]}],"categories":[{"id":"9abfe4a03928eb88a75a5cd95822dfef","name":"前端","slug":"categories/前端","path":"/categories/前端","parentId":"","postCount":36,"postIds":[]}],"excerpt":"<p>在开发 Vue 的组件库时，该如何将 <code>vue</code> 文件转换为 <code>commonjs</code> 或是 <code>ES Module</code> 规范的 <code>js</code> 文件，最后提供给他方使用？</p>\n<p>在这样的场景下，展开标题内容的研究与实践。</p>\n","more":"\n\n<h1 id=\"前言\">前言<a name=\"前言\" class=\"headerlink\" href=\"#前言\"></a></h1><p>目标：</p>\n<ul>\n<li>开发一个 npm 模块，内容是与 Vue 相关的组件库</li>\n<li>其中包含多个组件，支持用户选择按需引用的方式</li>\n</ul>\n<p>开发准备：</p>\n<ul>\n<li>源码直接采用 Vue 单组件文件的方式（样式除外，最终使用时再另行引入）</li>\n<li>脚本部分使用 ES6+ 语法、TypeScript</li>\n</ul>\n<blockquote>\n<p>倘若组件库的内容无需考虑按需的方式，可使用常规开发 npm module 的方式，私以为借助 webpack 与 vue-loader 是比较简便的。</p>\n<p>webpack 当然也能达到单文件编译的效果，下文会进行介绍。</p>\n</blockquote>\n<h1 id=\"个人方案\">个人方案<a name=\"个人方案\" class=\"headerlink\" href=\"#个人方案\"></a></h1><p>抛砖引玉，先介绍下自己探索后所使用的方式，另外该方式的另一个目的是与本人开发的一个<a href=\"https://github.com/daief/jugg\">小工具（jugg）</a>结合使用。</p>\n<p>其实我的方案，就是在开源库上套了下壳，主要依赖了</p>\n<ul>\n<li>@vue/component-compiler</li>\n<li>typescript</li>\n</ul>\n<p>关键部分就很简单了</p>\n<ol>\n<li>使用 <code>createDefaultCompiler</code> 实例化 <code>compiler</code></li>\n<li>使用 <code>compiler</code> 获取到 <code>descriptor</code>（描述符）对象，该对象包含三部分，对应 <code>模板 template</code>、<code>脚本 script</code> 和 <code>样式 style</code></li>\n<li>最后组装成一个对象，包含 JS 代码块以及 Map 信息</li>\n</ol>\n<p>以上，是 <code>@vue/component-compiler</code> 的使用，理论上到这里就结束了，但现实总不那么美好。当在 vue 文件中使用 TS 后，上述操作所产生的结果文件中会存在问题。</p>\n<p>所以，我在中间加了一个 TS 编译的步骤，手动更新 <code>descriptor</code> 的脚本部分，代码大概如下。</p>\n<blockquote>\n<p>@vue/component-compiler 中有 preprocessorOptions 的选项，看起来像是编译前的一些选项，但实在没找到相关的使用资料，<a href=\"https://github.com/vuejs/vue-component-compiler/blob/c8c7d3fb460e7fa4a341027bfb49cd7a17fe09e8/src/compiler.ts#L81\">源码中也只是作了个赋值操作</a>。</p>\n</blockquote>\n<pre class=\"hljs language-js\" hljs-language=\"js\"><code style=\"display:block;\"><span class=\"hljs-keyword\">const</span> { assemble, createDefaultCompiler } = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;@vue/component-compiler&#x27;</span>);\n<span class=\"hljs-keyword\">const</span> ts = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;typescript&#x27;</span>);\n\n<span class=\"hljs-comment\">/**\n * <span class=\"hljs-doctag\">@param</span> content {string} vue 单文件字符内容\n * <span class=\"hljs-doctag\">@param</span> filename {string} 文件名\n */</span>\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">compileVueFile</span>(<span class=\"hljs-params\">content, filename</span>) {\n  <span class=\"hljs-keyword\">const</span> compiler = <span class=\"hljs-title function_\">createDefaultCompiler</span>();\n  <span class=\"hljs-keyword\">const</span> descriptor = compiler.<span class=\"hljs-title function_\">compileToDescriptor</span>(filename, content);\n\n  <span class=\"hljs-comment\">// 手动提前编译</span>\n  <span class=\"hljs-comment\">// ❗️保留 ES Module，方便后续的一些操作</span>\n  descriptor.<span class=\"hljs-property\">script</span>.<span class=\"hljs-property\">code</span> = ts.<span class=\"hljs-title function_\">transpile</span>(\n    descriptor.<span class=\"hljs-property\">script</span>.<span class=\"hljs-property\">code</span>,\n    {\n      <span class=\"hljs-attr\">target</span>: ts.<span class=\"hljs-property\">ScriptTarget</span>.<span class=\"hljs-property\">ES2015</span>,\n      <span class=\"hljs-attr\">module</span>: ts.<span class=\"hljs-property\">ModuleKind</span>.<span class=\"hljs-property\">ESNext</span>,\n      <span class=\"hljs-attr\">importHelpers</span>: <span class=\"hljs-literal\">true</span>,\n    },\n    filename,\n  );\n\n  <span class=\"hljs-comment\">// 组装</span>\n  <span class=\"hljs-keyword\">const</span> result = <span class=\"hljs-title function_\">assemble</span>(compiler, filename, descriptor);\n\n  <span class=\"hljs-keyword\">return</span> result;\n}</code></pre><p>优化：默认方式会在结果文件中保留一些 helper 方法的定义，如果结果文件比较多，每个文件中都会重复定义了，所以可以提取出来，改成统一引用的方式。</p>\n<p>可使用如下修改：</p>\n<pre class=\"hljs language-js\" hljs-language=\"js\"><code style=\"display:block;\"><span class=\"hljs-comment\">// const result = assemble(compiler, filename, descriptor);</span>\n<span class=\"hljs-keyword\">const</span> result = <span class=\"hljs-title function_\">assemble</span>(compiler, filename, descriptor, {\n  <span class=\"hljs-attr\">normalizer</span>: <span class=\"hljs-string\">&#x27;~vue-runtime-helpers/dist/normalize-component.js&#x27;</span>,\n  <span class=\"hljs-attr\">styleInjector</span>: <span class=\"hljs-string\">&#x27;~vue-runtime-helpers/dist/inject-style/browser.js&#x27;</span>,\n  <span class=\"hljs-attr\">styleInjectorSSR</span>: <span class=\"hljs-string\">&#x27;~vue-runtime-helpers/dist/inject-style/server.js&#x27;</span>,\n});</code></pre><p>描述一下使用效果，有如下源码文件 <code>a.vue</code>:</p>\n<pre class=\"hljs language-html\" hljs-language=\"html\"><code style=\"display:block;\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Custom</span> /&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span>\n\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">lang</span>=<span class=\"hljs-string\">&quot;ts&quot;</span>&gt;</span><span class=\"language-javascript\">\n  <span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">Component</span>, <span class=\"hljs-title class_\">Vue</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;vue-property-decorator&#x27;</span>;\n  <span class=\"hljs-keyword\">import</span> <span class=\"hljs-title class_\">Custom</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;xx-lib/Custom.vue&#x27;</span>;\n\n  @<span class=\"hljs-title class_\">Component</span>({\n    <span class=\"hljs-attr\">components</span>: {\n      <span class=\"hljs-title class_\">Custom</span>,\n    },\n  })\n  <span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">extends</span> <span class=\"hljs-title class_\">Vue</span> {}\n</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></code></pre><p>可得到如下结果：</p>\n<pre class=\"hljs language-js\" hljs-language=\"js\"><code style=\"display:block;\"><span class=\"hljs-comment\">/* script */</span>\n<span class=\"hljs-keyword\">import</span> { __decorate } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;tslib&#x27;</span>;\n<span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">Component</span>, <span class=\"hljs-title class_\">Vue</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;vue-property-decorator&#x27;</span>;\n<span class=\"hljs-keyword\">import</span> <span class=\"hljs-title class_\">Custom</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;xx-lib/Custom.vue&#x27;</span>;\n<span class=\"hljs-keyword\">let</span> default_1 = <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">extends</span> <span class=\"hljs-title class_\">Vue</span> {};\ndefault_1 = <span class=\"hljs-title function_\">__decorate</span>(\n  [\n    <span class=\"hljs-title class_\">Component</span>({\n      <span class=\"hljs-attr\">components</span>: {\n        <span class=\"hljs-title class_\">Custom</span>,\n      },\n    }),\n  ],\n  default_1,\n);\n<span class=\"hljs-keyword\">const</span> __vue_script__ = default_1;\n\n<span class=\"hljs-comment\">/* template */</span>\n<span class=\"hljs-keyword\">var</span> __vue_render__ = <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">var</span> _vm = <span class=\"hljs-variable language_\">this</span>;\n  <span class=\"hljs-keyword\">var</span> _h = _vm.<span class=\"hljs-property\">$createElement</span>;\n  <span class=\"hljs-keyword\">var</span> _c = _vm.<span class=\"hljs-property\">_self</span>.<span class=\"hljs-property\">_c</span> || _h;\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">_c</span>(<span class=\"hljs-string\">&#x27;div&#x27;</span>, [<span class=\"hljs-title function_\">_c</span>(<span class=\"hljs-string\">&#x27;Custom&#x27;</span>)], <span class=\"hljs-number\">1</span>);\n};\n<span class=\"hljs-keyword\">var</span> __vue_staticRenderFns__ = [];\n__vue_render__.<span class=\"hljs-property\">_withStripped</span> = <span class=\"hljs-literal\">true</span>;\n\n<span class=\"hljs-comment\">/* style */</span>\n<span class=\"hljs-keyword\">const</span> __vue_inject_styles__ = <span class=\"hljs-literal\">undefined</span>;\n<span class=\"hljs-comment\">/* scoped */</span>\n<span class=\"hljs-keyword\">const</span> __vue_scope_id__ = <span class=\"hljs-literal\">undefined</span>;\n<span class=\"hljs-comment\">/* module identifier */</span>\n<span class=\"hljs-keyword\">const</span> __vue_module_identifier__ = <span class=\"hljs-literal\">undefined</span>;\n<span class=\"hljs-comment\">/* functional template */</span>\n<span class=\"hljs-keyword\">const</span> __vue_is_functional_template__ = <span class=\"hljs-literal\">false</span>;\n<span class=\"hljs-comment\">/* component normalizer */</span>\n<span class=\"hljs-keyword\">import</span> __vue_normalize__ <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;vue-runtime-helpers/dist/normalize-component.js&#x27;</span>;\n<span class=\"hljs-comment\">/* style inject */</span>\n\n<span class=\"hljs-comment\">/* style inject SSR */</span>\n\n<span class=\"hljs-comment\">/* style inject shadow dom */</span>\n\n<span class=\"hljs-keyword\">const</span> __vue_component__ = <span class=\"hljs-title function_\">__vue_normalize__</span>(\n  { <span class=\"hljs-attr\">render</span>: __vue_render__, <span class=\"hljs-attr\">staticRenderFns</span>: __vue_staticRenderFns__ },\n  __vue_inject_styles__,\n  __vue_script__,\n  __vue_scope_id__,\n  __vue_is_functional_template__,\n  __vue_module_identifier__,\n  <span class=\"hljs-literal\">false</span>,\n  <span class=\"hljs-literal\">undefined</span>,\n  <span class=\"hljs-literal\">undefined</span>,\n  <span class=\"hljs-literal\">undefined</span>,\n);\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> __vue_component__;</code></pre><p>这是优化了 helper 定义的结果，如果保留 helper 的定义，会有这样的差异（细心的同学一定发现 TS 的编译同样将 helper 提取到 tslib 中了）：</p>\n<pre class=\"hljs language-diff\" hljs-language=\"diff\"><code style=\"display:block;\">/* component normalizer */\n<span class=\"hljs-deletion\">-import __vue_normalize__ from &#x27;vue-runtime-helpers/dist/normalize-component.js&#x27;;</span>\n<span class=\"hljs-addition\">+function __vue_normalize__(</span>\n<span class=\"hljs-addition\">+  template, style, script,</span>\n<span class=\"hljs-addition\">+  scope, functional, moduleIdentifier, shadowMode,</span>\n<span class=\"hljs-addition\">+  createInjector, createInjectorSSR, createInjectorShadow</span>\n<span class=\"hljs-addition\">+) {</span>\n<span class=\"hljs-addition\">+  const component = (typeof script === &#x27;function&#x27; ? script.options : script) || {}</span>\n<span class=\"hljs-addition\">+</span>\n<span class=\"hljs-addition\">+  // For security concerns, we use only base name in production mode.</span>\n<span class=\"hljs-addition\">+  component.__file = &quot;/sandbox/src/vue/c.vue&quot;</span>\n<span class=\"hljs-addition\">+</span>\n<span class=\"hljs-addition\">+  if (!component.render) {</span>\n<span class=\"hljs-addition\">+    component.render = template.render</span>\n<span class=\"hljs-addition\">+    component.staticRenderFns = template.staticRenderFns</span>\n<span class=\"hljs-addition\">+    component._compiled = true</span>\n<span class=\"hljs-addition\">+</span>\n<span class=\"hljs-addition\">+    if (functional) component.functional = true</span>\n<span class=\"hljs-addition\">+  }</span>\n<span class=\"hljs-addition\">+</span>\n<span class=\"hljs-addition\">+  component._scopeId = scope</span>\n<span class=\"hljs-addition\">+</span>\n<span class=\"hljs-addition\">+  if (false) {</span>\n<span class=\"hljs-addition\">+    let hook</span>\n<span class=\"hljs-addition\">+    if (false) {</span>\n<span class=\"hljs-addition\">+      // In SSR.</span>\n<span class=\"hljs-addition\">+      hook = function(context) {</span>\n<span class=\"hljs-addition\">+        // 2.3 injection</span>\n<span class=\"hljs-addition\">+        context =</span>\n<span class=\"hljs-addition\">+          context || // cached call</span>\n<span class=\"hljs-addition\">+          (this.$vnode &amp;&amp; this.$vnode.ssrContext) || // stateful</span>\n<span class=\"hljs-addition\">+          (this.parent &amp;&amp; this.parent.$vnode &amp;&amp; this.parent.$vnode.ssrContext) // functional</span>\n<span class=\"hljs-addition\">+        // 2.2 with runInNewContext: true</span>\n<span class=\"hljs-addition\">+        if (!context &amp;&amp; typeof __VUE_SSR_CONTEXT__ !== &#x27;undefined&#x27;) {</span>\n<span class=\"hljs-addition\">+          context = __VUE_SSR_CONTEXT__</span>\n<span class=\"hljs-addition\">+        }</span>\n<span class=\"hljs-addition\">+        // inject component styles</span>\n<span class=\"hljs-addition\">+        if (style) {</span>\n<span class=\"hljs-addition\">+          style.call(this, createInjectorSSR(context))</span>\n<span class=\"hljs-addition\">+        }</span>\n<span class=\"hljs-addition\">+        // register component module identifier for async chunk inference</span>\n<span class=\"hljs-addition\">+        if (context &amp;&amp; context._registeredComponents) {</span>\n<span class=\"hljs-addition\">+          context._registeredComponents.add(moduleIdentifier)</span>\n<span class=\"hljs-addition\">+        }</span>\n<span class=\"hljs-addition\">+      }</span>\n<span class=\"hljs-addition\">+      // used by ssr in case component is cached and beforeCreate</span>\n<span class=\"hljs-addition\">+      // never gets called</span>\n<span class=\"hljs-addition\">+      component._ssrRegister = hook</span>\n<span class=\"hljs-addition\">+    }</span>\n<span class=\"hljs-addition\">+    else if (style) {</span>\n<span class=\"hljs-addition\">+      hook = shadowMode</span>\n<span class=\"hljs-addition\">+        ? function(context) {</span>\n<span class=\"hljs-addition\">+            style.call(this, createInjectorShadow(context, this.$root.$options.shadowRoot))</span>\n<span class=\"hljs-addition\">+          }</span>\n<span class=\"hljs-addition\">+        : function(context) {</span>\n<span class=\"hljs-addition\">+            style.call(this, createInjector(context))</span>\n<span class=\"hljs-addition\">+          }</span>\n<span class=\"hljs-addition\">+    }</span>\n<span class=\"hljs-addition\">+</span>\n<span class=\"hljs-addition\">+    if (hook !== undefined) {</span>\n<span class=\"hljs-addition\">+      if (component.functional) {</span>\n<span class=\"hljs-addition\">+        // register for functional component in vue file</span>\n<span class=\"hljs-addition\">+        const originalRender = component.render</span>\n<span class=\"hljs-addition\">+        component.render = function renderWithStyleInjection(h, context) {</span>\n<span class=\"hljs-addition\">+          hook.call(context)</span>\n<span class=\"hljs-addition\">+          return originalRender(h, context)</span>\n<span class=\"hljs-addition\">+        }</span>\n<span class=\"hljs-addition\">+      } else {</span>\n<span class=\"hljs-addition\">+        // inject component registration as beforeCreate hook</span>\n<span class=\"hljs-addition\">+        const existing = component.beforeCreate</span>\n<span class=\"hljs-addition\">+        component.beforeCreate = existing ? [].concat(existing, hook) : [hook]</span>\n<span class=\"hljs-addition\">+      }</span>\n<span class=\"hljs-addition\">+    }</span>\n<span class=\"hljs-addition\">+  }</span>\n<span class=\"hljs-addition\">+</span>\n<span class=\"hljs-addition\">+  return component</span>\n<span class=\"hljs-addition\">+}</span></code></pre><p>总之，就得到了一个在常规环境中能运行的 JS 文件了。最后，分别降级编译到 ES Module、commonjs 规范的目录下，我们的目标也基本达成了。</p>\n<p>下面是在线的 codesandbox 例子，可直接更改并查看效果。</p>\n<iframe\n  src=\"https://codesandbox.io/embed/compile-vue-file-to-js-file-nb09i?fontsize=14&hidenavigation=1&theme=dark&view=editor\"\n  style=\"width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;\"\n  title=\"compile-vue-file-to-js-file\"\n  allow=\"geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb\"\n  sandbox=\"allow-modals allow-forms allow-popups allow-scripts allow-same-origin\"\n></iframe>\n\n<h2 id=\"jugg 中的应用\">jugg 中的应用<a name=\"jugg 中的应用\" class=\"headerlink\" href=\"#jugg 中的应用\"></a></h2><p>顺便介绍一下上述内容在 jugg 中的实际应用效果，该部分 demo 的地址：<a href=\"https://github.com/daief/jugg/blob/master/examples/ts-lib/package.json\">https://github.com/daief/jugg/blob/master/examples/ts-lib/package.json</a>。</p>\n<p>源码结构。</p>\n<pre class=\"hljs language-bash\" hljs-language=\"bash\"><code style=\"display:block;\">src\n├── <span class=\"hljs-keyword\">function</span>\n│   └── index.ts\n├── index.ts\n├── react-components\n│   └── Button\n│       ├── index.tsx\n│       └── style\n│           ├── index.less\n│           └── index.ts\n├── shims-vue.d.ts\n├── style.ts\n└── vue-components        <span class=\"hljs-comment\"># vue 组件部分</span>\n    ├── Button\n    │   ├── button.vue\n    │   ├── index.ts\n    │   └── style\n    │       ├── index.less\n    │       └── index.ts\n    ├── Toast\n    │   ├── SubVue.vue\n    │   ├── Toast.vue\n    │   └── index.ts\n    └── mixins\n        └── base.ts</code></pre><p>简单地通过使用 <code>jugg build &amp; jugg lib</code> 命令即可得到如下的构建结果。</p>\n<pre class=\"hljs language-bash\" hljs-language=\"bash\"><code style=\"display:block;\">.\n├── dist                            <span class=\"hljs-comment\"># umd 规范</span>\n│   ├── index.css\n│   ├── index.css.map\n│   ├── index.js\n│   └── index.js.map\n├── es                              <span class=\"hljs-comment\"># ES Module 规范</span>\n│   ├── <span class=\"hljs-keyword\">function</span>\n│   │   ├── index.d.ts\n│   │   └── index.js\n│   ├── index.d.ts\n│   ├── index.js\n│   ├── react-components\n│   │   └── Button\n│   │       ├── index.d.ts\n│   │       ├── index.js\n│   │       └── style\n│   │           ├── css.js\n│   │           ├── index.css\n│   │           ├── index.d.ts\n│   │           ├── index.js\n│   │           └── index.less\n│   ├── style.d.ts\n│   ├── style.js\n│   └── vue-components\n│       ├── Button\n│       │   ├── button.js\n│       │   ├── index.d.ts\n│       │   ├── index.js\n│       │   └── style\n│       │       ├── css.js\n│       │       ├── index.css\n│       │       ├── index.d.ts\n│       │       ├── index.js\n│       │       └── index.less\n│       ├── Toast\n│       │   ├── SubVue.js\n│       │   ├── Toast.js\n│       │   ├── index.d.ts\n│       │   └── index.js\n│       └── mixins\n│           ├── base.d.ts\n│           └── base.js\n└── lib                              <span class=\"hljs-comment\"># commonjs 规范</span>\n    ├── <span class=\"hljs-keyword\">function</span>\n    │   ├── index.d.ts\n    │   └── index.js\n    ├── index.d.ts\n    ├── index.js\n    ├── react-components\n    │   └── Button\n    │       ├── index.d.ts\n    │       ├── index.js\n    │       └── style\n    │           ├── css.js\n    │           ├── index.css\n    │           ├── index.d.ts\n    │           ├── index.js\n    │           └── index.less\n    ├── style.d.ts\n    ├── style.js\n    └── vue-components\n        ├── Button\n        │   ├── button.js\n        │   ├── index.d.ts\n        │   ├── index.js\n        │   └── style\n        │       ├── css.js\n        │       ├── index.css\n        │       ├── index.d.ts\n        │       ├── index.js\n        │       └── index.less\n        ├── Toast\n        │   ├── SubVue.js\n        │   ├── Toast.js\n        │   ├── index.d.ts\n        │   └── index.js\n        └── mixins\n            ├── base.d.ts\n            └── base.js</code></pre><h1 id=\"开源项目\">开源项目<a name=\"开源项目\" class=\"headerlink\" href=\"#开源项目\"></a></h1><p>遇到问题，当然少不了参考开源项目的做法，下面拉了两个简单介绍一下。</p>\n<h2 id=\"vant\">vant<a name=\"vant\" class=\"headerlink\" href=\"#vant\"></a></h2><p>vant：<a href=\"https://github.com/youzan/vant/\">https://github.com/youzan/vant/</a></p>\n<p>vant 没有使用 vue 文件，使用 tsx 作为源码文件（在 vue 中使用 jsx 语法），通过 babel 来对每个源文件进行编译。</p>\n<p>构建文件参考：<a href=\"https://github.com/youzan/vant/blob/abbee1062b587e5d4360bad4f362a33e8e793398/build/build-components.js\">地址</a>。</p>\n<p>vant 的构建结果目录参考：<a href=\"https://www.jsdelivr.com/package/npm/vant?version=2.2.15\">地址</a>。</p>\n<h2 id=\"element\">element<a name=\"element\" class=\"headerlink\" href=\"#element\"></a></h2><p>element：<a href=\"https://github.com/ElemeFE/element\">https://github.com/ElemeFE/element</a></p>\n<p>element 选择 webpack 作为编译工具，把每个组件作为 webpack 的入口，最终打包出多个结果文件。</p>\n<p>构建文件参考：<a href=\"https://github.com/ElemeFE/element/blob/6ec5f8e900ff698cf30e9479d692784af836a108/build/webpack.component.js#L10\">地址</a></p>\n<p>element 的构建结果目录参考：<a href=\"https://www.jsdelivr.com/package/npm/element-ui?version=2.13.0\">地址</a>。</p>\n<h1 id=\"结语\">结语<a name=\"结语\" class=\"headerlink\" href=\"#结语\"></a></h1><p>此外，还可以选择 rollup 作为构建的工具。总而言之，爱生活、爱折腾，多一种方式、多一种选择。</p>\n","hash":"5966b21e5799b4c577a2838b44570616","isArticle":true,"sort":0,"filename":"","raw":"","prev":{"id":"some-web-debugging-skills","slug":"post/some-web-debugging-skills","path":"/post/some-web-debugging-skills","title":"也许有用的 Web 调试技能","comments":true,"published":true,"date":"2019-11-03T00:37:13.000Z","updated":"","tags":[{"id":"986c37480b1f1c2e443504b38b6361b4","name":"Chrome","postCount":1,"postIds":[]}],"categories":[{"id":"9abfe4a03928eb88a75a5cd95822dfef","name":"前端","slug":"categories/前端","path":"/categories/前端","parentId":"","postCount":36,"postIds":[]}],"excerpt":"<p>记录那些年，我们都在用的调试方法。第一部分主要是一些 Chrome 开发者工具的使用记录；剩余部分是一些其他的调试手段，包括移动端调试、代理内容的介绍。了解 Chrome 开发者的同学，可以跳过第一部分。</p>\n<p><img alt=\"谷歌娘\" loading=\"lazy\" title=\"谷歌娘\" width=\"300px\" class=\"post-image \" src=\"/images/ebf8ca7dbb0fa30d4c6a59d74be9b956.chrome-chan.jpg\" onerror=\"this.onerror=null;this.src='/images/image-error.jpg';\"></p>\n","more":"","hash":"5f05c9ed34d94d93218397db987e5fde","isArticle":true,"sort":0,"filename":"","raw":"","prev":null,"next":null,"tocHtml":""},"next":{"id":"year-end-summary-2019","slug":"post/year-end-summary-2019","path":"/post/year-end-summary-2019","title":"我的 2019","comments":true,"published":true,"date":"2019-12-29T15:17:00.000Z","updated":"","tags":[{"id":"aefcbfca08c840aeb8bd72dc1c8ff7f9","name":"生活","postCount":2,"postIds":[]}],"categories":[{"id":"aefcbfca08c840aeb8bd72dc1c8ff7f9","name":"生活","slug":"categories/生活","path":"/categories/生活","parentId":"","postCount":3,"postIds":[]}],"excerpt":"<p>距离 2019 结束只有不到三天，好好写完这份总结应该是今年最后一件事了。</p>\n","more":"","hash":"2220f02f2f6555d142c83d74fa93520f","isArticle":true,"sort":0,"filename":"","raw":"","prev":null,"next":null,"tocHtml":""}}},"tocHtml":"","simplePages":[{"id":"41a3cc43f8af362b82fbe2aa97817528","slug":"resume","path":"/resume"},{"id":"fabb5629b694584be9ff314ab8187577","slug":"resume-v2","path":"/resume-v2"},{"id":"34787f8e18c76ce0f4c3cc680ab728ef","slug":"resume-v1","path":"/resume-v1"},{"id":"ac298b1fdf5a34ac83bb9376ccdde006","slug":"about","path":"/about"}],"simplePageDetail":{"post":null}},"labels":{"labels":[],"postPagination":{"current":1,"pageSize":10,"totalPages":0,"result":[]}}}</script>
    <script>
      if (/MSIE \d|Trident.*rv:/.test(navigator.userAgent)) {
        // redirect IE to Edge
        // This browser is no longer supported
        window.location.href = 'microsoft-edge:' + window.location.href;
        alert('请使用 Chrome/Edge/Firefox/Safari 等现代浏览器。');
        throw new Error('请使用 Chrome/Edge/Firefox/Safari 等现代浏览器。');
      }
    </script>
    <script type="module" crossorigin src="/assets/index.bf8c73c6.js"></script>
    <link rel="stylesheet" href="/assets/index.48ca4a1c.css">
  </head>
  <body  data-head-attrs="">
    <div id="app"><!--[--><div class="m-4 max-w-screen-xl flex flex-wrap md:m-6 xl:mx-auto md:flex-nowrap"><div class="w-full flex-shrink-0 self-start md:sticky md:top-6 md:w-48"><div class="blog-base-area-box py-6 mb-4"><img class="block w-24 h-24 rounded-full mx-auto" src="https://avatars.githubusercontent.com/u/19222089?v=4"><div class="mt-5 px-3 text-center"><h1 class="text-c-title font-normal"><a href="" class="unset">daief的个人日志</a></h1><p class="mt-2 text-sm text-c-secondary break-words">遇见你，遇见幸运💫</p><div class="mt-3 text-xs flex justify-center"><a href="/" class="unset"><svg class="if-icon" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-wenzhang" data-v-43154e2c></use></svg>(51) </a><span class="mx-1 text-c-secondary">|</span><a href="/tags" class="unset"><svg class="if-icon" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-tag" data-v-43154e2c></use></svg>(42) </a><span class="mx-1 text-c-secondary">|</span><a href="/categories" class="unset"><svg class="if-icon" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-category" data-v-43154e2c></use></svg>(16) </a></div><div class="mt-6 flex justify-center"><a to="https://github.com/daief" replace="false" href="https://github.com/daief" target="_blank" class="unset cursor-pointer"><!--[--><svg class="if-icon" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-github" data-v-43154e2c></use></svg><!--]--></a><span class="mx-2"></span><a to="mailto:defeng_mail@163.com" replace="false" href="mailto:defeng_mail@163.com" target="_blank" class="unset cursor-pointer"><!--[--><svg class="if-icon" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-email" data-v-43154e2c></use></svg><!--]--></a></div></div><div class="mt-6"><div class="text-center" data-v-73630894><!--[--><a href="/" class="unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link" data-v-73630894>首页</a><a href="/categories/" class="unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link" data-v-73630894>分类</a><a href="/tags/" class="unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link" data-v-73630894>标签</a><a href="/about/" class="unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link unset
            h-10
            flex
            items-center
            justify-center
            border-b border-gray-100
            text-sm text-c-text
            menu-link" data-v-73630894>关于</a><!--]--></div></div></div><div class="hidden md:block mt-2"><div class="footer text-center text-sm" data-v-8b3f10e8><div data-v-8b3f10e8><div data-v-8b3f10e8>© 2017-2025</div></div><div class="flex items-center justify-center" data-v-8b3f10e8>By <a href="https://github.com/daief/blog/tree/master/packages/gugu" target="_blank" data-v-8b3f10e8>gugu</a>  &amp; daief - <span class="picker-wrap" data-v-7aa3923e data-v-8b3f10e8><span data-v-7aa3923e></span></span></div><!----><!----><div data-v-8b3f10e8><a href="/sitemap.xml" target="_blank" data-v-8b3f10e8>站点地图</a></div></div></div></div><div class="w-full md:w-0 md:flex-grow md:mx-5"><div><!--[--><div class="blog-base-area-box px-4 py-8 md:px-8"><div><h1 class="text-2xl font-normal break-words">编译 Vue 单文件组件至 JS 文件</h1><div class="my-4 text-xs text-c-secondary"><div class="flex items-center flex-wrap"><!----><!----><div class="whitespace-nowrap"><svg class="if-icon text-c-secondary mx-1 text-c-secondary mx-1" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-calendar" data-v-43154e2c></use></svg>2019-11-28</div><!--[--><span class="mx-1">|</span><div class="whitespace-nowrap"><svg class="if-icon text-c-secondary mx-1 text-c-secondary mx-1" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-folder" data-v-43154e2c></use></svg><!--[--><!--[--><a href="/categories/前端" class="unset">前端</a><span></span><!--]--><!--]--></div><!--]--><!----></div></div><!-- content --><div class="markdown-body text-sm text-gray-800 leading-loose"><p>在开发 Vue 的组件库时，该如何将 <code>vue</code> 文件转换为 <code>commonjs</code> 或是 <code>ES Module</code> 规范的 <code>js</code> 文件，最后提供给他方使用？</p>
<p>在这样的场景下，展开标题内容的研究与实践。</p>

<a id="more" class="h-0 mt-3 block"></a>


<h1 id="前言">前言<a name="前言" class="headerlink" href="#前言"></a></h1><p>目标：</p>
<ul>
<li>开发一个 npm 模块，内容是与 Vue 相关的组件库</li>
<li>其中包含多个组件，支持用户选择按需引用的方式</li>
</ul>
<p>开发准备：</p>
<ul>
<li>源码直接采用 Vue 单组件文件的方式（样式除外，最终使用时再另行引入）</li>
<li>脚本部分使用 ES6+ 语法、TypeScript</li>
</ul>
<blockquote>
<p>倘若组件库的内容无需考虑按需的方式，可使用常规开发 npm module 的方式，私以为借助 webpack 与 vue-loader 是比较简便的。</p>
<p>webpack 当然也能达到单文件编译的效果，下文会进行介绍。</p>
</blockquote>
<h1 id="个人方案">个人方案<a name="个人方案" class="headerlink" href="#个人方案"></a></h1><p>抛砖引玉，先介绍下自己探索后所使用的方式，另外该方式的另一个目的是与本人开发的一个<a href="https://github.com/daief/jugg">小工具（jugg）</a>结合使用。</p>
<p>其实我的方案，就是在开源库上套了下壳，主要依赖了</p>
<ul>
<li>@vue/component-compiler</li>
<li>typescript</li>
</ul>
<p>关键部分就很简单了</p>
<ol>
<li>使用 <code>createDefaultCompiler</code> 实例化 <code>compiler</code></li>
<li>使用 <code>compiler</code> 获取到 <code>descriptor</code>（描述符）对象，该对象包含三部分，对应 <code>模板 template</code>、<code>脚本 script</code> 和 <code>样式 style</code></li>
<li>最后组装成一个对象，包含 JS 代码块以及 Map 信息</li>
</ol>
<p>以上，是 <code>@vue/component-compiler</code> 的使用，理论上到这里就结束了，但现实总不那么美好。当在 vue 文件中使用 TS 后，上述操作所产生的结果文件中会存在问题。</p>
<p>所以，我在中间加了一个 TS 编译的步骤，手动更新 <code>descriptor</code> 的脚本部分，代码大概如下。</p>
<blockquote>
<p>@vue/component-compiler 中有 preprocessorOptions 的选项，看起来像是编译前的一些选项，但实在没找到相关的使用资料，<a href="https://github.com/vuejs/vue-component-compiler/blob/c8c7d3fb460e7fa4a341027bfb49cd7a17fe09e8/src/compiler.ts#L81">源码中也只是作了个赋值操作</a>。</p>
</blockquote>
<pre class="hljs language-js" hljs-language="js"><code style="display:block;"><span class="hljs-keyword">const</span> { assemble, createDefaultCompiler } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@vue/component-compiler&#x27;</span>);
<span class="hljs-keyword">const</span> ts = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;typescript&#x27;</span>);

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> content {string} vue 单文件字符内容
 * <span class="hljs-doctag">@param</span> filename {string} 文件名
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">compileVueFile</span>(<span class="hljs-params">content, filename</span>) {
  <span class="hljs-keyword">const</span> compiler = <span class="hljs-title function_">createDefaultCompiler</span>();
  <span class="hljs-keyword">const</span> descriptor = compiler.<span class="hljs-title function_">compileToDescriptor</span>(filename, content);

  <span class="hljs-comment">// 手动提前编译</span>
  <span class="hljs-comment">// ❗️保留 ES Module，方便后续的一些操作</span>
  descriptor.<span class="hljs-property">script</span>.<span class="hljs-property">code</span> = ts.<span class="hljs-title function_">transpile</span>(
    descriptor.<span class="hljs-property">script</span>.<span class="hljs-property">code</span>,
    {
      <span class="hljs-attr">target</span>: ts.<span class="hljs-property">ScriptTarget</span>.<span class="hljs-property">ES2015</span>,
      <span class="hljs-attr">module</span>: ts.<span class="hljs-property">ModuleKind</span>.<span class="hljs-property">ESNext</span>,
      <span class="hljs-attr">importHelpers</span>: <span class="hljs-literal">true</span>,
    },
    filename,
  );

  <span class="hljs-comment">// 组装</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">assemble</span>(compiler, filename, descriptor);

  <span class="hljs-keyword">return</span> result;
}</code></pre><p>优化：默认方式会在结果文件中保留一些 helper 方法的定义，如果结果文件比较多，每个文件中都会重复定义了，所以可以提取出来，改成统一引用的方式。</p>
<p>可使用如下修改：</p>
<pre class="hljs language-js" hljs-language="js"><code style="display:block;"><span class="hljs-comment">// const result = assemble(compiler, filename, descriptor);</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">assemble</span>(compiler, filename, descriptor, {
  <span class="hljs-attr">normalizer</span>: <span class="hljs-string">&#x27;~vue-runtime-helpers/dist/normalize-component.js&#x27;</span>,
  <span class="hljs-attr">styleInjector</span>: <span class="hljs-string">&#x27;~vue-runtime-helpers/dist/inject-style/browser.js&#x27;</span>,
  <span class="hljs-attr">styleInjectorSSR</span>: <span class="hljs-string">&#x27;~vue-runtime-helpers/dist/inject-style/server.js&#x27;</span>,
});</code></pre><p>描述一下使用效果，有如下源码文件 <code>a.vue</code>:</p>
<pre class="hljs language-html" hljs-language="html"><code style="display:block;"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Custom</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript">
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span>, <span class="hljs-title class_">Vue</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-property-decorator&#x27;</span>;
  <span class="hljs-keyword">import</span> <span class="hljs-title class_">Custom</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;xx-lib/Custom.vue&#x27;</span>;

  @<span class="hljs-title class_">Component</span>({
    <span class="hljs-attr">components</span>: {
      <span class="hljs-title class_">Custom</span>,
    },
  })
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">Vue</span> {}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre><p>可得到如下结果：</p>
<pre class="hljs language-js" hljs-language="js"><code style="display:block;"><span class="hljs-comment">/* script */</span>
<span class="hljs-keyword">import</span> { __decorate } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;tslib&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span>, <span class="hljs-title class_">Vue</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-property-decorator&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Custom</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;xx-lib/Custom.vue&#x27;</span>;
<span class="hljs-keyword">let</span> default_1 = <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">Vue</span> {};
default_1 = <span class="hljs-title function_">__decorate</span>(
  [
    <span class="hljs-title class_">Component</span>({
      <span class="hljs-attr">components</span>: {
        <span class="hljs-title class_">Custom</span>,
      },
    }),
  ],
  default_1,
);
<span class="hljs-keyword">const</span> __vue_script__ = default_1;

<span class="hljs-comment">/* template */</span>
<span class="hljs-keyword">var</span> __vue_render__ = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">var</span> _vm = <span class="hljs-variable language_">this</span>;
  <span class="hljs-keyword">var</span> _h = _vm.<span class="hljs-property">$createElement</span>;
  <span class="hljs-keyword">var</span> _c = _vm.<span class="hljs-property">_self</span>.<span class="hljs-property">_c</span> || _h;
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">_c</span>(<span class="hljs-string">&#x27;div&#x27;</span>, [<span class="hljs-title function_">_c</span>(<span class="hljs-string">&#x27;Custom&#x27;</span>)], <span class="hljs-number">1</span>);
};
<span class="hljs-keyword">var</span> __vue_staticRenderFns__ = [];
__vue_render__.<span class="hljs-property">_withStripped</span> = <span class="hljs-literal">true</span>;

<span class="hljs-comment">/* style */</span>
<span class="hljs-keyword">const</span> __vue_inject_styles__ = <span class="hljs-literal">undefined</span>;
<span class="hljs-comment">/* scoped */</span>
<span class="hljs-keyword">const</span> __vue_scope_id__ = <span class="hljs-literal">undefined</span>;
<span class="hljs-comment">/* module identifier */</span>
<span class="hljs-keyword">const</span> __vue_module_identifier__ = <span class="hljs-literal">undefined</span>;
<span class="hljs-comment">/* functional template */</span>
<span class="hljs-keyword">const</span> __vue_is_functional_template__ = <span class="hljs-literal">false</span>;
<span class="hljs-comment">/* component normalizer */</span>
<span class="hljs-keyword">import</span> __vue_normalize__ <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-runtime-helpers/dist/normalize-component.js&#x27;</span>;
<span class="hljs-comment">/* style inject */</span>

<span class="hljs-comment">/* style inject SSR */</span>

<span class="hljs-comment">/* style inject shadow dom */</span>

<span class="hljs-keyword">const</span> __vue_component__ = <span class="hljs-title function_">__vue_normalize__</span>(
  { <span class="hljs-attr">render</span>: __vue_render__, <span class="hljs-attr">staticRenderFns</span>: __vue_staticRenderFns__ },
  __vue_inject_styles__,
  __vue_script__,
  __vue_scope_id__,
  __vue_is_functional_template__,
  __vue_module_identifier__,
  <span class="hljs-literal">false</span>,
  <span class="hljs-literal">undefined</span>,
  <span class="hljs-literal">undefined</span>,
  <span class="hljs-literal">undefined</span>,
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> __vue_component__;</code></pre><p>这是优化了 helper 定义的结果，如果保留 helper 的定义，会有这样的差异（细心的同学一定发现 TS 的编译同样将 helper 提取到 tslib 中了）：</p>
<pre class="hljs language-diff" hljs-language="diff"><code style="display:block;">/* component normalizer */
<span class="hljs-deletion">-import __vue_normalize__ from &#x27;vue-runtime-helpers/dist/normalize-component.js&#x27;;</span>
<span class="hljs-addition">+function __vue_normalize__(</span>
<span class="hljs-addition">+  template, style, script,</span>
<span class="hljs-addition">+  scope, functional, moduleIdentifier, shadowMode,</span>
<span class="hljs-addition">+  createInjector, createInjectorSSR, createInjectorShadow</span>
<span class="hljs-addition">+) {</span>
<span class="hljs-addition">+  const component = (typeof script === &#x27;function&#x27; ? script.options : script) || {}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  // For security concerns, we use only base name in production mode.</span>
<span class="hljs-addition">+  component.__file = &quot;/sandbox/src/vue/c.vue&quot;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  if (!component.render) {</span>
<span class="hljs-addition">+    component.render = template.render</span>
<span class="hljs-addition">+    component.staticRenderFns = template.staticRenderFns</span>
<span class="hljs-addition">+    component._compiled = true</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+    if (functional) component.functional = true</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  component._scopeId = scope</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  if (false) {</span>
<span class="hljs-addition">+    let hook</span>
<span class="hljs-addition">+    if (false) {</span>
<span class="hljs-addition">+      // In SSR.</span>
<span class="hljs-addition">+      hook = function(context) {</span>
<span class="hljs-addition">+        // 2.3 injection</span>
<span class="hljs-addition">+        context =</span>
<span class="hljs-addition">+          context || // cached call</span>
<span class="hljs-addition">+          (this.$vnode &amp;&amp; this.$vnode.ssrContext) || // stateful</span>
<span class="hljs-addition">+          (this.parent &amp;&amp; this.parent.$vnode &amp;&amp; this.parent.$vnode.ssrContext) // functional</span>
<span class="hljs-addition">+        // 2.2 with runInNewContext: true</span>
<span class="hljs-addition">+        if (!context &amp;&amp; typeof __VUE_SSR_CONTEXT__ !== &#x27;undefined&#x27;) {</span>
<span class="hljs-addition">+          context = __VUE_SSR_CONTEXT__</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+        // inject component styles</span>
<span class="hljs-addition">+        if (style) {</span>
<span class="hljs-addition">+          style.call(this, createInjectorSSR(context))</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+        // register component module identifier for async chunk inference</span>
<span class="hljs-addition">+        if (context &amp;&amp; context._registeredComponents) {</span>
<span class="hljs-addition">+          context._registeredComponents.add(moduleIdentifier)</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+      // used by ssr in case component is cached and beforeCreate</span>
<span class="hljs-addition">+      // never gets called</span>
<span class="hljs-addition">+      component._ssrRegister = hook</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    else if (style) {</span>
<span class="hljs-addition">+      hook = shadowMode</span>
<span class="hljs-addition">+        ? function(context) {</span>
<span class="hljs-addition">+            style.call(this, createInjectorShadow(context, this.$root.$options.shadowRoot))</span>
<span class="hljs-addition">+          }</span>
<span class="hljs-addition">+        : function(context) {</span>
<span class="hljs-addition">+            style.call(this, createInjector(context))</span>
<span class="hljs-addition">+          }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+    if (hook !== undefined) {</span>
<span class="hljs-addition">+      if (component.functional) {</span>
<span class="hljs-addition">+        // register for functional component in vue file</span>
<span class="hljs-addition">+        const originalRender = component.render</span>
<span class="hljs-addition">+        component.render = function renderWithStyleInjection(h, context) {</span>
<span class="hljs-addition">+          hook.call(context)</span>
<span class="hljs-addition">+          return originalRender(h, context)</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+      } else {</span>
<span class="hljs-addition">+        // inject component registration as beforeCreate hook</span>
<span class="hljs-addition">+        const existing = component.beforeCreate</span>
<span class="hljs-addition">+        component.beforeCreate = existing ? [].concat(existing, hook) : [hook]</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  return component</span>
<span class="hljs-addition">+}</span></code></pre><p>总之，就得到了一个在常规环境中能运行的 JS 文件了。最后，分别降级编译到 ES Module、commonjs 规范的目录下，我们的目标也基本达成了。</p>
<p>下面是在线的 codesandbox 例子，可直接更改并查看效果。</p>
<iframe
  src="https://codesandbox.io/embed/compile-vue-file-to-js-file-nb09i?fontsize=14&hidenavigation=1&theme=dark&view=editor"
  style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
  title="compile-vue-file-to-js-file"
  allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb"
  sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"
></iframe>

<h2 id="jugg 中的应用">jugg 中的应用<a name="jugg 中的应用" class="headerlink" href="#jugg 中的应用"></a></h2><p>顺便介绍一下上述内容在 jugg 中的实际应用效果，该部分 demo 的地址：<a href="https://github.com/daief/jugg/blob/master/examples/ts-lib/package.json">https://github.com/daief/jugg/blob/master/examples/ts-lib/package.json</a>。</p>
<p>源码结构。</p>
<pre class="hljs language-bash" hljs-language="bash"><code style="display:block;">src
├── <span class="hljs-keyword">function</span>
│   └── index.ts
├── index.ts
├── react-components
│   └── Button
│       ├── index.tsx
│       └── style
│           ├── index.less
│           └── index.ts
├── shims-vue.d.ts
├── style.ts
└── vue-components        <span class="hljs-comment"># vue 组件部分</span>
    ├── Button
    │   ├── button.vue
    │   ├── index.ts
    │   └── style
    │       ├── index.less
    │       └── index.ts
    ├── Toast
    │   ├── SubVue.vue
    │   ├── Toast.vue
    │   └── index.ts
    └── mixins
        └── base.ts</code></pre><p>简单地通过使用 <code>jugg build &amp; jugg lib</code> 命令即可得到如下的构建结果。</p>
<pre class="hljs language-bash" hljs-language="bash"><code style="display:block;">.
├── dist                            <span class="hljs-comment"># umd 规范</span>
│   ├── index.css
│   ├── index.css.map
│   ├── index.js
│   └── index.js.map
├── es                              <span class="hljs-comment"># ES Module 规范</span>
│   ├── <span class="hljs-keyword">function</span>
│   │   ├── index.d.ts
│   │   └── index.js
│   ├── index.d.ts
│   ├── index.js
│   ├── react-components
│   │   └── Button
│   │       ├── index.d.ts
│   │       ├── index.js
│   │       └── style
│   │           ├── css.js
│   │           ├── index.css
│   │           ├── index.d.ts
│   │           ├── index.js
│   │           └── index.less
│   ├── style.d.ts
│   ├── style.js
│   └── vue-components
│       ├── Button
│       │   ├── button.js
│       │   ├── index.d.ts
│       │   ├── index.js
│       │   └── style
│       │       ├── css.js
│       │       ├── index.css
│       │       ├── index.d.ts
│       │       ├── index.js
│       │       └── index.less
│       ├── Toast
│       │   ├── SubVue.js
│       │   ├── Toast.js
│       │   ├── index.d.ts
│       │   └── index.js
│       └── mixins
│           ├── base.d.ts
│           └── base.js
└── lib                              <span class="hljs-comment"># commonjs 规范</span>
    ├── <span class="hljs-keyword">function</span>
    │   ├── index.d.ts
    │   └── index.js
    ├── index.d.ts
    ├── index.js
    ├── react-components
    │   └── Button
    │       ├── index.d.ts
    │       ├── index.js
    │       └── style
    │           ├── css.js
    │           ├── index.css
    │           ├── index.d.ts
    │           ├── index.js
    │           └── index.less
    ├── style.d.ts
    ├── style.js
    └── vue-components
        ├── Button
        │   ├── button.js
        │   ├── index.d.ts
        │   ├── index.js
        │   └── style
        │       ├── css.js
        │       ├── index.css
        │       ├── index.d.ts
        │       ├── index.js
        │       └── index.less
        ├── Toast
        │   ├── SubVue.js
        │   ├── Toast.js
        │   ├── index.d.ts
        │   └── index.js
        └── mixins
            ├── base.d.ts
            └── base.js</code></pre><h1 id="开源项目">开源项目<a name="开源项目" class="headerlink" href="#开源项目"></a></h1><p>遇到问题，当然少不了参考开源项目的做法，下面拉了两个简单介绍一下。</p>
<h2 id="vant">vant<a name="vant" class="headerlink" href="#vant"></a></h2><p>vant：<a href="https://github.com/youzan/vant/">https://github.com/youzan/vant/</a></p>
<p>vant 没有使用 vue 文件，使用 tsx 作为源码文件（在 vue 中使用 jsx 语法），通过 babel 来对每个源文件进行编译。</p>
<p>构建文件参考：<a href="https://github.com/youzan/vant/blob/abbee1062b587e5d4360bad4f362a33e8e793398/build/build-components.js">地址</a>。</p>
<p>vant 的构建结果目录参考：<a href="https://www.jsdelivr.com/package/npm/vant?version=2.2.15">地址</a>。</p>
<h2 id="element">element<a name="element" class="headerlink" href="#element"></a></h2><p>element：<a href="https://github.com/ElemeFE/element">https://github.com/ElemeFE/element</a></p>
<p>element 选择 webpack 作为编译工具，把每个组件作为 webpack 的入口，最终打包出多个结果文件。</p>
<p>构建文件参考：<a href="https://github.com/ElemeFE/element/blob/6ec5f8e900ff698cf30e9479d692784af836a108/build/webpack.component.js#L10">地址</a></p>
<p>element 的构建结果目录参考：<a href="https://www.jsdelivr.com/package/npm/element-ui?version=2.13.0">地址</a>。</p>
<h1 id="结语">结语<a name="结语" class="headerlink" href="#结语"></a></h1><p>此外，还可以选择 rollup 作为构建的工具。总而言之，爱生活、爱折腾，多一种方式、多一种选择。</p>
</div><div class="mt-6 has-child mt-6 mt-6" data-v-3adb2250><!--[-->☘️<!--]--></div><div class="flex flex-wrap justify-center text-c-secondary text-sm mt-6"><!--[--><a href="/tags/Vue" class="unset block my-1 mx-2"><svg class="if-icon" aria-hidden="true" data-v-43154e2c><use xlink:href="#if-tag" data-v-43154e2c></use></svg> Vue</a><!--]--></div></div></div><!-- 上下篇 --><div class="blog-base-area-box px-4 py-4 my-8 flex justify-between md:px-8"><!--[--><div class="pr-3 w-0 flex-grow break-words"><!--[--><div class="text-c-secondary text-xs mb-1">上一篇 </div><div class="text-sm"><a href="/post/some-web-debugging-skills" class="unset">也许有用的 Web 调试技能</a></div><!--]--></div><div class="text-right pl-3 w-0 flex-grow break-words"><!--[--><div class="text-c-secondary text-xs mb-1">下一篇 </div><div class="text-sm"><a href="/post/year-end-summary-2019" class="unset">我的 2019</a></div><!--]--></div><!--]--></div><!-- 评论 --><div id="comment" class="blog-base-area-box p-4 my-8 md:px-8"><h1 class="text-c-title text-xl block font-normal mb-5"><a href="#comment" class="unset text-c-title hover:text-c-title hover:underline"> 留言板 </a></h1><div class="utterances"></div></div><!--]--></div></div><div class="blog-base-area-box hidden md:block w-48 sticky top-6"><div style="display:none;" class="site-toc-wrap leading-6 break-all text-sm p-3"></div></div></div><div class="block mb-4 md:hidden"><div class="footer text-center text-sm" data-v-8b3f10e8><div data-v-8b3f10e8><div data-v-8b3f10e8>© 2017-2025</div></div><div class="flex items-center justify-center" data-v-8b3f10e8>By <a href="https://github.com/daief/blog/tree/master/packages/gugu" target="_blank" data-v-8b3f10e8>gugu</a>  &amp; daief - <span class="picker-wrap" data-v-7aa3923e data-v-8b3f10e8><span data-v-7aa3923e></span></span></div><!----><!----><div data-v-8b3f10e8><a href="/sitemap.xml" target="_blank" data-v-8b3f10e8>站点地图</a></div></div></div><div class="fixed z-100 right-8 bottom-14" data-v-49aec8bc><div class="blog-base-area-box action-btn opacity-0 pointer-events-none" data-v-49aec8bc><svg class="if-icon" aria-hidden="true" data-v-43154e2c data-v-49aec8bc><use xlink:href="#if-top" data-v-43154e2c></use></svg></div></div><!--]--></div>
    
  </body>
</html>
