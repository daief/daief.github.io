<!DOCTYPE html><html ssthtmlattrs="" lang="en"><head>
    <title>记一次单页应用的加载优化 | Daief's Blog</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--ssr-head-partial-->
    <script>
      if (/MSIE \d|Trident.*rv:/.test(navigator.userAgent)) {
        // redirect IE to Edge
        // This browser is no longer supported
        window.location.href = 'microsoft-edge:' + window.location.href;
        alert('请使用 Chrome/Edge/Firefox/Safari 等现代浏览器。');
        throw new Error('请使用 Chrome/Edge/Firefox/Safari 等现代浏览器。');
      }
    </script>
    <script type="module" crossorigin="" src="/assets/app-DvX1Smg_.js"></script>
    <link rel="stylesheet" crossorigin="" href="/assets/app-lBf8QYnm.css">
  <link rel="modulepreload" crossorigin="" href="/assets/vm__post_try-to-improve-spa-load-performance_-BXpZaH_Z.js"><link rel="stylesheet" href="/assets/vm__post_try-to-improve-spa-load-performance_-DQp8QXHc.css"><link rel="modulepreload" crossorigin="" href="/assets/meta-info-C-tMy3g2.js"><link rel="modulepreload" crossorigin="" href="/assets/toc-DNILfFl5.js"><link rel="stylesheet" href="/assets/toc-m8VwwUnR.css"><meta name="description" content=""><meta property="og:title" content="记一次单页应用的加载优化 | Daief's Blog"><meta property="og:description" content=""><meta property="og:image" content="https://avatars.githubusercontent.com/u/19222089?v=4"><meta name="author" content="daief"></head>
  <body ssrbodyattrs="">
    <div class="page-bg-gradient pointer-events-none fixed start-0 top-0 z-[-1] h-screen w-full"></div>
    <div id="app" data-server-rendered="true"><!--[--><div class="flex flex-col min-h-screen transition-colors duration-300"><header data-v-c69b61b1=""><div id="nav-container" class="max-w-app mx-auto text-foreground sm:bg-transparent" data-v-c69b61b1=""><div id="top-nav-wrap" class="relative grid grid-cols-2 auto-rows-auto w-full items-center justify-between p-4 sm:py-6 sm:flex sm:grid-rows-1" data-v-c69b61b1=""><a href="/" class="py-1 text-xl leading-8 font-semibold whitespace-nowrap sm:my-auto sm:text-2xl sm:leading-none" data-v-c69b61b1=""><!--[-->Daief's Blog<!--]--></a><div class="flex-center justify-end space-x-4 sm:hidden" data-v-c69b61b1=""><button class="cursor-pointer relative" data-v-c69b61b1=""><div class="w-10 h-6 rounded-3xl border-[3px] border-[#d1d5da] transition-300 dark:border-[#6E40C9]"><div class="absolute top-1/2 -left-0.5 transform -translate-y-1/2 transition-300 w-[28px] h-[28px] bg-[#2f363d] rounded-full flex-center dark:bg-[#6E40C9] dark:left-[calc(100%-28px+2px)]"><span class="text-[16px]"><!--?xml version="1.0" standalone="no"?-->
<svg t="1761650889094" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2362" xmlns:xlink="http://www.w3.org/1999/xlink" width="1em" height="1em">
  <path d="M554.632 298.914h-85.264c-11.782 0-21.344-9.546-21.344-21.328s9.562-21.328 21.344-21.328h85.264c11.81 0 21.374 9.546 21.374 21.328s-9.562 21.328-21.374 21.328z" fill="#F6BB42" p-id="2363"></path>
  <path d="M810.562 725.43c-282.664 0-511.812-229.164-511.812-511.826 0-63.53 11.594-124.372 32.748-180.51C137.91 106.076 0.196 293.04 0.196 512.172c0 282.662 229.15 511.812 511.828 511.812 219.102 0 406.096-137.714 479.034-331.302-56.126 21.156-116.934 32.748-180.496 32.748z" fill="#FFCE54" p-id="2364"></path>
  <path d="M554.632 981.328c-282.632 0-511.78-229.148-511.78-511.812 0-130.434 48.81-249.476 129.122-339.848C66.6 223.416 0.196 360.02 0.196 512.172c0 282.662 229.15 511.812 511.828 511.812 152.106 0 288.726-66.406 382.47-171.806-90.368 80.368-209.43 129.15-339.862 129.15z" fill="#F6BB42" p-id="2365"></path>
  <path d="M767.938 277.586c0 11.782-9.562 21.328-21.376 21.328-11.75 0-21.312-9.546-21.312-21.328s9.562-21.328 21.312-21.328c11.814 0 21.376 9.546 21.376 21.328z" fill="#4A89DC" p-id="2366"></path>
  <path d="M661.316 490.844c0 11.766-9.562 21.328-21.374 21.328-11.75 0-21.312-9.562-21.312-21.328 0-11.782 9.562-21.328 21.312-21.328 11.812 0 21.374 9.546 21.374 21.328z" fill="#48CFAD" p-id="2367"></path>
  <path d="M1023.804 234.586c0 11.782-9.562 21.328-21.312 21.328-11.748 0-21.31-9.546-21.31-21.328 0-11.78 9.562-21.326 21.31-21.326 11.75 0 21.312 9.546 21.312 21.326z" fill="#ED5564" p-id="2368"></path>
  <path d="M639.944 21.328c0 11.782-9.5 21.328-21.312 21.328-11.75 0-21.312-9.546-21.312-21.328 0-11.766 9.562-21.312 21.312-21.312a21.288 21.288 0 0 1 21.312 21.312z" fill="#AC92EB" p-id="2369"></path>
  <path d="M512.024 192.276c-11.782 0-21.344 9.562-21.344 21.328v127.964c0 11.766 9.562 21.312 21.344 21.312 11.75 0 21.312-9.546 21.312-21.312v-127.964c0-11.766-9.562-21.328-21.312-21.328z" fill="#FFCE54" p-id="2370"></path>
  <path d="M874.56 426.862c-11.812 0-21.312 9.546-21.312 21.328v127.934c0 11.812 9.5 21.344 21.312 21.344 11.748 0 21.308-9.532 21.308-21.344v-127.934c0.002-11.78-9.56-21.328-21.308-21.328z" fill="#F6BB42" p-id="2371"></path>
  <path d="M917.182 533.484h-85.306c-11.75 0-21.312-9.546-21.312-21.312 0-11.782 9.562-21.328 21.312-21.328h85.306c11.812 0 21.312 9.546 21.312 21.328 0 11.766-9.5 21.312-21.312 21.312z" fill="#FFCE54" p-id="2372"></path>
</svg>
</span></div></div></button><a role="button" class="text-2xl p-1" data-v-c69b61b1=""><svg class="iconify-svg block" viewBox="0 0 24 24" width="1.2em" height="1.2em" data-v-c69b61b1=""><path fill="currentColor" d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg></a></div><nav id="nav-menu" class="col-start-1 col-end-3 w-full flex-col items-center static top-full left-0 right-0 z-10 mt-4 sm:mt-0 sm:ms-2 sm:flex-row sm:justify-end sm:space-x-4 sm:py-0 sm:flex hidden" data-v-c69b61b1=""><ul id="menu-items" class="w-full place-content-center gap-2 sm:flex sm:w-auto sm:gap-x-5 sm:gap-y-0" data-v-c69b61b1=""><!--[--><li class="col-span-2" data-v-c69b61b1=""><a href="/" class="flex justify-center items-center h-full px-4 py-3 font-medium hover:text-accent sm:px-2 sm:py-1 nav-active" data-v-c69b61b1=""><!--[-->文章<!--]--></a></li><li class="col-span-2" data-v-c69b61b1=""><a href="/tags/" class="flex justify-center items-center h-full px-4 py-3 font-medium hover:text-accent sm:px-2 sm:py-1" data-v-c69b61b1=""><!--[-->标签<!--]--></a></li><li class="col-span-2" data-v-c69b61b1=""><a href="/about/" class="flex justify-center items-center h-full px-4 py-3 font-medium hover:text-accent sm:px-2 sm:py-1" data-v-c69b61b1=""><!--[-->关于<!--]--></a></li><!--]--><li class="col-span-1 hidden sm:block" data-v-c69b61b1=""><a class="flex justify-center items-center h-full px-4 py-3 sm:px-2 sm:py-1" data-v-c69b61b1=""><button class="cursor-pointer relative" data-v-c69b61b1=""><div class="w-10 h-6 rounded-3xl border-[3px] border-[#d1d5da] transition-300 dark:border-[#6E40C9]"><div class="absolute top-1/2 -left-0.5 transform -translate-y-1/2 transition-300 w-[28px] h-[28px] bg-[#2f363d] rounded-full flex-center dark:bg-[#6E40C9] dark:left-[calc(100%-28px+2px)]"><span class="text-[16px]"><!--?xml version="1.0" standalone="no"?-->
<svg t="1761650889094" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2362" xmlns:xlink="http://www.w3.org/1999/xlink" width="1em" height="1em">
  <path d="M554.632 298.914h-85.264c-11.782 0-21.344-9.546-21.344-21.328s9.562-21.328 21.344-21.328h85.264c11.81 0 21.374 9.546 21.374 21.328s-9.562 21.328-21.374 21.328z" fill="#F6BB42" p-id="2363"></path>
  <path d="M810.562 725.43c-282.664 0-511.812-229.164-511.812-511.826 0-63.53 11.594-124.372 32.748-180.51C137.91 106.076 0.196 293.04 0.196 512.172c0 282.662 229.15 511.812 511.828 511.812 219.102 0 406.096-137.714 479.034-331.302-56.126 21.156-116.934 32.748-180.496 32.748z" fill="#FFCE54" p-id="2364"></path>
  <path d="M554.632 981.328c-282.632 0-511.78-229.148-511.78-511.812 0-130.434 48.81-249.476 129.122-339.848C66.6 223.416 0.196 360.02 0.196 512.172c0 282.662 229.15 511.812 511.828 511.812 152.106 0 288.726-66.406 382.47-171.806-90.368 80.368-209.43 129.15-339.862 129.15z" fill="#F6BB42" p-id="2365"></path>
  <path d="M767.938 277.586c0 11.782-9.562 21.328-21.376 21.328-11.75 0-21.312-9.546-21.312-21.328s9.562-21.328 21.312-21.328c11.814 0 21.376 9.546 21.376 21.328z" fill="#4A89DC" p-id="2366"></path>
  <path d="M661.316 490.844c0 11.766-9.562 21.328-21.374 21.328-11.75 0-21.312-9.562-21.312-21.328 0-11.782 9.562-21.328 21.312-21.328 11.812 0 21.374 9.546 21.374 21.328z" fill="#48CFAD" p-id="2367"></path>
  <path d="M1023.804 234.586c0 11.782-9.562 21.328-21.312 21.328-11.748 0-21.31-9.546-21.31-21.328 0-11.78 9.562-21.326 21.31-21.326 11.75 0 21.312 9.546 21.312 21.326z" fill="#ED5564" p-id="2368"></path>
  <path d="M639.944 21.328c0 11.782-9.5 21.328-21.312 21.328-11.75 0-21.312-9.546-21.312-21.328 0-11.766 9.562-21.312 21.312-21.312a21.288 21.288 0 0 1 21.312 21.312z" fill="#AC92EB" p-id="2369"></path>
  <path d="M512.024 192.276c-11.782 0-21.344 9.562-21.344 21.328v127.964c0 11.766 9.562 21.312 21.344 21.312 11.75 0 21.312-9.546 21.312-21.312v-127.964c0-11.766-9.562-21.328-21.312-21.328z" fill="#FFCE54" p-id="2370"></path>
  <path d="M874.56 426.862c-11.812 0-21.312 9.546-21.312 21.328v127.934c0 11.812 9.5 21.344 21.312 21.344 11.748 0 21.308-9.532 21.308-21.344v-127.934c0.002-11.78-9.56-21.328-21.308-21.328z" fill="#F6BB42" p-id="2371"></path>
  <path d="M917.182 533.484h-85.306c-11.75 0-21.312-9.546-21.312-21.312 0-11.782 9.562-21.328 21.312-21.328h85.306c11.812 0 21.312 9.546 21.312 21.328 0 11.766-9.5 21.312-21.312 21.312z" fill="#FFCE54" p-id="2372"></path>
</svg>
</span></div></div></button></a></li></ul></nav></div></div><div class="mx-auto max-w-app px-4" data-v-c69b61b1=""><hr class="border-border" aria-hidden="true" data-v-c69b61b1=""></div></header><main class="flex-grow max-w-app mx-auto px-4 py-8 w-full text-foreground"><!--[--><div class="relative" data-v-bc1541f8=""><article data-v-bc1541f8=""><header data-v-bc1541f8=""><h1 class="text-foreground text-3xl font-bold mb-4" data-v-bc1541f8=""> 记一次单页应用的加载优化 </h1><div class="flex items-center gap-x-3.5 gap-y-0.5 text-foreground opacity-80 flex-wrap" data-v-bc1541f8=""><!--[--><!--[--><div class="inline-flex items-center gap-x-0.5 whitespace-nowrap"><svg class="iconify-svg block" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path fill="currentColor" d="M7 11h2v2H7zm14-6v14c0 1.11-.89 2-2 2H5a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h1V1h2v2h8V1h2v2h1a2 2 0 0 1 2 2M5 7h14V5H5zm14 12V9H5v10zm-4-6v-2h2v2zm-4 0v-2h2v2zm-4 2h2v2H7zm8 2v-2h2v2zm-4 0v-2h2v2z"></path></svg><span>发表于：<time datetime="2018-12-25T23:54:23.000Z">2018/12/25</time></span></div><!--[--><a href="/tags/SPA/1/" class="inline-flex items-center foreground-link"><svg class="iconify-svg block select-none mr-0.5 text-foreground" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path fill="currentColor" d="m5.41 21l.71-4h-4l.35-2h4l1.06-6h-4l.35-2h4l.71-4h2l-.71 4h6l.71-4h2l-.71 4h4l-.35 2h-4l-1.06 6h4l-.35 2h-4l-.71 4h-2l.71-4h-6l-.71 4zM9.53 9l-1.06 6h6l1.06-6z"></path></svg>SPA</a><a href="/tags/performance/1/" class="inline-flex items-center foreground-link"><svg class="iconify-svg block select-none mr-0.5 text-foreground" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path fill="currentColor" d="m5.41 21l.71-4h-4l.35-2h4l1.06-6h-4l.35-2h4l.71-4h2l-.71 4h6l.71-4h2l-.71 4h4l-.35 2h-4l-1.06 6h4l-.35 2h-4l-.71 4h-2l.71-4h-6l-.71 4zM9.53 9l-1.06 6h6l1.06-6z"></path></svg>performance</a><!--]--><!--]--><!--]--></div></header><div class="md-prose max-w-none dark:prose-invert mt-6" data-v-bc1541f8=""><!--[--><p data-v-bc1541f8="">如今的前端页面越来越丰富了，承载着各种功能。而随之增长的则是相应的代码量，加上三方 SDK 的接入以及单页应用（SPA）的特性，一次页面访问会出现慢的感觉，是时候来关注页面的加载优化了。</p><p data-v-bc1541f8="">本文简略描述关于 React 单页应用的加载优化，下文所指加载一般包括下载、执行两个步骤。</p><a id="more" href="#more" class="block" data-v-bc1541f8=""></a><h2 id="%E4%B8%80%E6%AC%A1%E9%A1%B5%E9%9D%A2%EF%BC%88SPA%EF%BC%89%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B" data-v-bc1541f8="">一次页面（SPA）加载过程<a name="%E4%B8%80%E6%AC%A1%E9%A1%B5%E9%9D%A2%EF%BC%88SPA%EF%BC%89%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B" class="headerlink" href="#%E4%B8%80%E6%AC%A1%E9%A1%B5%E9%9D%A2%EF%BC%88SPA%EF%BC%89%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B" data-v-bc1541f8=""></a></h2><ol data-v-bc1541f8=""><li data-v-bc1541f8="">下载 HTML 文档，开始解析；</li><li data-v-bc1541f8="">由上至下下载 HTML 文档中引入的资源（CSS、JS），当 CSS 加载完毕可认为完成首次渲染绘制；</li><li data-v-bc1541f8="">等待 JS 下载、执行，完成 SDK 加载、React 框架加载；</li><li data-v-bc1541f8="">业务代码加载、初始化、页面拉取数据、事件响应等，完毕后可认为此时为首次有效绘制；</li><li data-v-bc1541f8="">其他图片、媒体等加载，至此页面基本加载完毕。</li></ol><p data-v-bc1541f8=""><img alt="5c224eb0c4ff9e2b4d699618" loading="lazy" title="5c224eb0c4ff9e2b4d699618" class="post-image" src="https://www.superbed.cn/pic/5c224eb0c4ff9e2b4d699618" onerror="this.onerror=null;this.src='/images/image-error.jpg';" data-v-bc1541f8=""></p><h2 id="%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91" data-v-bc1541f8="">优化方向<a name="%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91" class="headerlink" href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91" data-v-bc1541f8=""></a></h2><p data-v-bc1541f8="">针对上述过程以及页面特性，以前端手段，接下来从以下四个个方面入手优化：</p><ol data-v-bc1541f8=""><li data-v-bc1541f8="">资源大小方面。只要资源更小，下载速度和执行速度都将获得提升；</li><li data-v-bc1541f8="">资源加载，浏览器方面；</li><li data-v-bc1541f8="">首屏方面优化，避免展示空白给用户；</li><li data-v-bc1541f8="">CDN 加速、图片显示优化、缓存等其他方面。</li></ol><h2 id="%E5%87%8F%E5%B0%8F%E8%B5%84%E6%BA%90%E5%A4%A7%E5%B0%8F" data-v-bc1541f8="">减小资源大小<a name="%E5%87%8F%E5%B0%8F%E8%B5%84%E6%BA%90%E5%A4%A7%E5%B0%8F" class="headerlink" href="#%E5%87%8F%E5%B0%8F%E8%B5%84%E6%BA%90%E5%A4%A7%E5%B0%8F" data-v-bc1541f8=""></a></h2><p data-v-bc1541f8="">性能提升很多时候就是一门做减法的艺术。</p><h3 id="%E4%BB%A3%E7%A0%81%E6%8B%86%E5%88%86%E3%80%81%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD" data-v-bc1541f8="">代码拆分、动态加载<a name="%E4%BB%A3%E7%A0%81%E6%8B%86%E5%88%86%E3%80%81%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD" class="headerlink" href="#%E4%BB%A3%E7%A0%81%E6%8B%86%E5%88%86%E3%80%81%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD" data-v-bc1541f8=""></a></h3><p data-v-bc1541f8="">一般情况下，SPA 的一个特点就是借助 webpack 等工具将最终代码打包在一个或两类（main.js、vendor.js）文件中，这些文件实际上包含了一整个应用的内容。这样带来了一个问题，当只访问其中一个路由页面时，加载了很多不必要的代码。</p><p data-v-bc1541f8="">那么，很自然地，可以选择把不属于当前页面的模块分离出去，等用到之时，再进行获取。幸运的是，在 webpack 的打包环境中，只需要使用动态导入的语法就能自动实现代码分离：<code data-v-bc1541f8="">import x from 'x'</code> =&gt; <code data-v-bc1541f8="">import('x').then(x =&gt; { /* */ })</code>。</p><p data-v-bc1541f8=""><img alt="5c224d3dc4ff9e2b4d699612" loading="lazy" title="5c224d3dc4ff9e2b4d699612" class="post-image" src="https://www.superbed.cn/pic/5c224d3dc4ff9e2b4d699612" onerror="this.onerror=null;this.src='/images/image-error.jpg';" data-v-bc1541f8=""></p><p data-v-bc1541f8="">对于 React 应用，有一个十分好用的库 <a href="https://github.com/jamiebuilds/react-loadable" target="_blank" class="" data-v-bc1541f8=""><!--[-->react-loadable<!--]--></a>，基于动态导入语法封装。使用官方的介绍，用于装载具有动态导入组件的高阶组件。该库实现基于组件粒度的拆分，将动态导入的过程、结果都包装成了组件，使用也十分简单，来看下具体使用：</p><pre class="shiki shiki-themes min-light night-owl" style="--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627;" tabindex="0" data-v-bc1541f8=""><code data-v-bc1541f8=""><span class="line" data-v-bc1541f8=""><span style="--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8=""> Loadable </span><span style="--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">from</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8=""> '</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">react-loadable</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">;</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8=""> Loading </span><span style="--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">from</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8=""> '</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">./my-loading-component</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">;</span></span>
<span class="line" data-v-bc1541f8=""></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic;" data-v-bc1541f8="">// 结果是个组件，可直接使用</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic;" data-v-bc1541f8="">// 加载时自动展示 loading 样式</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8="">const</span><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> LoadableComponent</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8=""> =</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> Loadable</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#C792EA;" data-v-bc1541f8="">{</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8="">  loader</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8="">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D9F5DD;" data-v-bc1541f8=""> ()</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8=""> =&gt;</span><span style="--shiki-light:#D32F2F;--shiki-dark:#7FDBCA;" data-v-bc1541f8=""> import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">(</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">./my-component</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">)</span><span style="--shiki-light:#212121;--shiki-dark:#C792EA;" data-v-bc1541f8="">,</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">  loading</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8="">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D7DBE0;" data-v-bc1541f8=""> Loading</span><span style="--shiki-light:#212121;--shiki-dark:#C792EA;" data-v-bc1541f8="">,</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#C792EA;" data-v-bc1541f8="">}</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">);</span></span>
<span class="line" data-v-bc1541f8=""></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">export</span><span style="--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> default</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8=""> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB8B;" data-v-bc1541f8=""> App</span><span style="--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB8B;" data-v-bc1541f8=""> React</span><span style="--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#C5E478;" data-v-bc1541f8="">Component</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8=""> {</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8="">  render</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">()</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8=""> {</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">    return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#7FDBCA;" data-v-bc1541f8=""> &lt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#F78C6C;" data-v-bc1541f8="">LoadableComponent</span><span style="--shiki-light:#24292EFF;--shiki-dark:#7FDBCA;" data-v-bc1541f8="">/&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">;</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">  }</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">}</span></span></code></pre><p data-v-bc1541f8="">如此一来，再使用 webpack 打包，会发现多了不少用于动态引入的文件。另外，代码的组织对于拆分是有一定影响的。以下分别是未拆分、基于路由拆分、整理代码（期间删了部分无用代码）后基于路由拆分情况下的打包情况。可对比看出每个页面加载的总资源大小减少了。</p><p data-v-bc1541f8=""><img alt="5c224d3dc4ff9e2b4d699613" loading="lazy" title="5c224d3dc4ff9e2b4d699613" class="post-image" src="https://www.superbed.cn/pic/5c224d3dc4ff9e2b4d699613" onerror="this.onerror=null;this.src='/images/image-error.jpg';" data-v-bc1541f8=""></p><p data-v-bc1541f8=""><code data-v-bc1541f8="">webpack-bundle-analyzer</code> 是一个十分有用的打包结果分析插件，能帮助我们直观看出打包结果的具体组成，从而作出进一步调整优化。</p><p data-v-bc1541f8=""><img alt="5c224d3dc4ff9e2b4d699614" loading="lazy" title="5c224d3dc4ff9e2b4d699614" class="post-image" src="https://www.superbed.cn/pic/5c224d3dc4ff9e2b4d699614" onerror="this.onerror=null;this.src='/images/image-error.jpg';" data-v-bc1541f8=""></p><p data-v-bc1541f8="">温馨提示：</p><ul data-v-bc1541f8=""><li data-v-bc1541f8="">TypeScript 中使 <code data-v-bc1541f8="">import()</code> 生效，得在 tsconfig.json 中设置 <code data-v-bc1541f8="">"module": "esnext"</code>，<a href="https://github.com/webpack/webpack/issues/5703#issuecomment-357512412" target="_blank" class="" data-v-bc1541f8=""><!--[-->更多详情<!--]--></a>。</li><li data-v-bc1541f8="">该方式对于大型 SPA 的优化效果较为明显。</li></ul><h3 id="%E5%87%8F%E5%B0%91%E4%BB%A3%E7%A0%81%E4%BD%93%E7%A7%AF" data-v-bc1541f8="">减少代码体积<a name="%E5%87%8F%E5%B0%91%E4%BB%A3%E7%A0%81%E4%BD%93%E7%A7%AF" class="headerlink" href="#%E5%87%8F%E5%B0%91%E4%BB%A3%E7%A0%81%E4%BD%93%E7%A7%AF" data-v-bc1541f8=""></a></h3><p data-v-bc1541f8="">这里所说的主要是一些细节方面的处理，一般效果可能会比较小，往往不需要要太多的改动，能优化一点是一点，秉承蚊子腿也是肉的原则。</p><ol data-v-bc1541f8=""><li data-v-bc1541f8="">Webpack 支持摇树（Tree Shaking），借助该特性，能自动优化掉代码中的无用部分。但该特性的使用并不那么简单，以至于实际效果的表现并不理想。简单了解，它是要借助 ES6 的静态导入语法进行分析的，而经常使用的 npm 模块都是 commonjs 方式，不支持 Tree Shaking。这里对此没有过多研究，更多细节可参考文章底部列出的文章。</li><li data-v-bc1541f8="">注意模块的按需引入。典型的就是 lodash，不要只用到几个方法却全部打包了。当然在插件配置支持的情况下，可直接<code data-v-bc1541f8="">import { throttle } from 'lodash'</code>。</li><li data-v-bc1541f8="">有些工具会自动包含部分 polyfill，生产环境又引了一份 polyfill，应注意避免重复引入。</li><li data-v-bc1541f8="">随着迭代等种种因素，产生了用不到的代码，最后主动删除。</li><li data-v-bc1541f8="">...</li></ol><h2 id="%E6%B5%8F%E8%A7%88%E5%99%A8%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96" data-v-bc1541f8="">浏览器资源加载优化<a name="%E6%B5%8F%E8%A7%88%E5%99%A8%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96" class="headerlink" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96" data-v-bc1541f8=""></a></h2><p data-v-bc1541f8="">在此，引入一个概念：关键请求链（Critical-Request-Chains）。</p><blockquote data-v-bc1541f8=""><p data-v-bc1541f8="">关键请求链：可视区域渲染完毕（首屏），并对于用户来说可用时，必须加载的资源请求队列，就叫做关键请求链。</p></blockquote><p data-v-bc1541f8="">简单来说，对于直接在 index.html 文档中引用的 JS、CSS、图片等资源被认为是关键请求链，浏览器会优先进行处理。</p><h3 id="%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%85%B3%E9%94%AE%E8%AF%B7%E6%B1%82%E9%93%BE" data-v-bc1541f8="">动态加载与关键请求链<a name="%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%85%B3%E9%94%AE%E8%AF%B7%E6%B1%82%E9%93%BE" class="headerlink" href="#%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%85%B3%E9%94%AE%E8%AF%B7%E6%B1%82%E9%93%BE" data-v-bc1541f8=""></a></h3><p data-v-bc1541f8="">以之前提到的拆分结果为例，拆分后单个页面需要加载的资源大小变化不显著，这时候去测量页面的加载性能得到的结果也许会是不升反降，降的主要是首次有效绘制。</p><p data-v-bc1541f8=""><img alt="5c224d3dc4ff9e2b4d699615" loading="lazy" title="5c224d3dc4ff9e2b4d699615" class="post-image" src="https://www.superbed.cn/pic/5c224d3dc4ff9e2b4d699615" onerror="this.onerror=null;this.src='/images/image-error.jpg';" data-v-bc1541f8=""></p><p data-v-bc1541f8="">这是单个页面的加载情况，动态加载了两个模块，而这两个模块是不属于关键请求链的。这种情况下，该页面的加载情况简述如下：</p><ol data-v-bc1541f8=""><li data-v-bc1541f8="">vendor.js、app.js 加载完毕；</li><li data-v-bc1541f8="">上述 JS 执行到特定逻辑判定该页面需要 2.js、6.js，于是发送请求，加载对应资源；</li><li data-v-bc1541f8="">2.js、6.js 动态 JS 部分加载完毕；</li><li data-v-bc1541f8="">最终页面显示。</li></ol><p data-v-bc1541f8="">该步骤相比初始状态多了一个步骤，当这些新增的开销大于初始状态的时候，页面加载的整体性能是下降的。</p><p data-v-bc1541f8="">要在当前情况下发挥拆分代码、动态加载的意义，有以下一种思路：</p><p data-v-bc1541f8="">假设一个 SPA 包含列表页、详情页，列表页是一级<strong data-v-bc1541f8="">关键页面</strong>，可以只对详情页相关的内容进行分离。如此一来，对于列表页依旧只有 app.js、vendor.js 部分，但是少了详情页相关的东西，因此做到了关键页面的性能加载提升。</p><h3 id="%E5%BB%B6%E8%BF%9F%E9%9D%9E%E5%85%B3%E9%94%AE%E8%B5%84%E6%BA%90" data-v-bc1541f8="">延迟非关键资源<a name="%E5%BB%B6%E8%BF%9F%E9%9D%9E%E5%85%B3%E9%94%AE%E8%B5%84%E6%BA%90" class="headerlink" href="#%E5%BB%B6%E8%BF%9F%E9%9D%9E%E5%85%B3%E9%94%AE%E8%B5%84%E6%BA%90" data-v-bc1541f8=""></a></h3><p data-v-bc1541f8="">除了必要的框架、业务代码，页面中常常引入了一些 SDK，比如打点功能。</p><p data-v-bc1541f8="">以打点为例，这类资源实际上跟首屏的渲染没有关系，即使在页面全部加载完毕三秒后再引入也是无伤大雅的。</p><p data-v-bc1541f8="">而我们的现状是，这类资源被直接写在 head 部分引入，被浏览器认为是关键资源优先处理，势必对页面的加载有一定的影响。</p><p data-v-bc1541f8="">对于这类非关键资源，不需要列在关键请求链当中。以此处的神策打点为例，我们将他的顺序写在文档底部，并添加了 <code data-v-bc1541f8="">defer</code> 属性，告诉浏览器神策的下载不是阻塞的，并且将它的执行时机进行延后。</p><p data-v-bc1541f8="">回顾之前的加载瀑布图，可以看到 <code data-v-bc1541f8="">sensorsdata.min.js</code> 的加载优先级（Priority）是<code data-v-bc1541f8="">Low</code>，此时神策的加载是不影响首屏的渲染了。</p><p data-v-bc1541f8="">script 异步加载属性 <code data-v-bc1541f8="">async</code>、<code data-v-bc1541f8="">defer</code> 介绍：</p><p data-v-bc1541f8=""><img alt="5c224d3bc4ff9e2b4d69960e" loading="lazy" title="5c224d3bc4ff9e2b4d69960e" class="post-image" src="https://www.superbed.cn/pic/5c224d3bc4ff9e2b4d69960e" onerror="this.onerror=null;this.src='/images/image-error.jpg';" data-v-bc1541f8=""></p><p data-v-bc1541f8="">早期情况，浏览器对于 JS 的下载、执行可能是严格串行模式处理的，只有上一个 JS 加载完毕后才会开始下一个 JS 的下载、执行。</p><p data-v-bc1541f8="">但实际上，目前的浏览器对于资源加载都有自己的策略，基本上都会去并行下载资源，即使是单线程执行的 JS 脚本（观察上述加载瀑布图也能发现这点）。因为这样做能够减少 JS 的下载时间，不过有一点是不变的，严格按照 JS 的顺序进行执行。</p><h3 id="%E5%87%8F%E5%B0%91%E8%AF%B7%E6%B1%82" data-v-bc1541f8="">减少请求<a name="%E5%87%8F%E5%B0%91%E8%AF%B7%E6%B1%82" class="headerlink" href="#%E5%87%8F%E5%B0%91%E8%AF%B7%E6%B1%82" data-v-bc1541f8=""></a></h3><p data-v-bc1541f8="">此处排除图片等媒体资源进行讨论。</p><p data-v-bc1541f8="">往往为了缓存考虑，我们会把 React、ReactDOM 单独抽离，打包时也会采取一种策略将第三方不经常改动的部分抽离出来。因此，一个页面的请求数会变多。但浏览器对于一个域名的并发请求下载数量是有限制的。再加上 SDK、polyfill 等可能就突破上限了，那么多余的只能等待。</p><p data-v-bc1541f8="">针对这种情况一般有几种方式：</p><ol data-v-bc1541f8=""><li data-v-bc1541f8="">资源够小的时候直接嵌入在 HTML 文档中；</li><li data-v-bc1541f8="">考虑是否有必要将打包结果拆分出 vendor；</li><li data-v-bc1541f8="">多个资源的请求进行合并。</li></ol><h2 id="%E9%A6%96%E5%B1%8F%E7%A9%BA%E7%99%BD%E4%BC%98%E5%8C%96" data-v-bc1541f8="">首屏空白优化<a name="%E9%A6%96%E5%B1%8F%E7%A9%BA%E7%99%BD%E4%BC%98%E5%8C%96" class="headerlink" href="#%E9%A6%96%E5%B1%8F%E7%A9%BA%E7%99%BD%E4%BC%98%E5%8C%96" data-v-bc1541f8=""></a></h2><p data-v-bc1541f8="">即使优化了资源加载，SPA 首屏空白的问题是依旧存在的，因为要等待 JS 的下载、执行。</p><p data-v-bc1541f8="">问题的根本是 HTML 文档中只有一个空节点，那么只要预先插入一些内容就能解决白屏问题了，处理方法很简单。</p><h3 id="%E9%80%9A%E7%94%A8%20Loading%20%E6%A0%B7%E5%BC%8F" data-v-bc1541f8="">通用 Loading 样式<a name="%E9%80%9A%E7%94%A8%20Loading%20%E6%A0%B7%E5%BC%8F" class="headerlink" href="#%E9%80%9A%E7%94%A8%20Loading%20%E6%A0%B7%E5%BC%8F" data-v-bc1541f8=""></a></h3><p data-v-bc1541f8="">处理起来最方便的一种，只要在 HTML 模板文件中插入内容即可。写在 <code data-v-bc1541f8="">#root</code> 中是因为在 React 渲染后会自动顶掉了 Loading，免去了手动的处理。</p><pre class="shiki shiki-themes min-light night-owl" style="--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627;" tabindex="0" data-v-bc1541f8=""><code data-v-bc1541f8=""><span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#7FDBCA;" data-v-bc1541f8="">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#CAECE6;" data-v-bc1541f8="">div</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> id</span><span style="--shiki-light:#D32F2F;--shiki-dark:#7FDBCA;" data-v-bc1541f8="">=</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">"</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">root</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">"</span><span style="--shiki-light:#24292EFF;--shiki-dark:#7FDBCA;" data-v-bc1541f8="">&gt;</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#7FDBCA;" data-v-bc1541f8="">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#CAECE6;" data-v-bc1541f8="">div</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> id</span><span style="--shiki-light:#D32F2F;--shiki-dark:#7FDBCA;" data-v-bc1541f8="">=</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">"</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">loading</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">"</span><span style="--shiki-light:#24292EFF;--shiki-dark:#7FDBCA;" data-v-bc1541f8="">&gt;</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic;" data-v-bc1541f8="">    &lt;!-- ... 一些 loading 代码 --&gt;</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#7FDBCA;" data-v-bc1541f8="">  &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#CAECE6;" data-v-bc1541f8="">div</span><span style="--shiki-light:#24292EFF;--shiki-dark:#7FDBCA;" data-v-bc1541f8="">&gt;</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#7FDBCA;" data-v-bc1541f8="">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#CAECE6;" data-v-bc1541f8="">div</span><span style="--shiki-light:#24292EFF;--shiki-dark:#7FDBCA;" data-v-bc1541f8="">&gt;</span></span></code></pre><h3 id="%E5%A4%9A%E9%A1%B5%E9%9D%A2%E5%AE%9A%E5%88%B6%E7%9A%84%E9%A2%84%E6%B8%B2%E6%9F%93%E6%A0%B7%E5%BC%8F" data-v-bc1541f8="">多页面定制的预渲染样式<a name="%E5%A4%9A%E9%A1%B5%E9%9D%A2%E5%AE%9A%E5%88%B6%E7%9A%84%E9%A2%84%E6%B8%B2%E6%9F%93%E6%A0%B7%E5%BC%8F" class="headerlink" href="#%E5%A4%9A%E9%A1%B5%E9%9D%A2%E5%AE%9A%E5%88%B6%E7%9A%84%E9%A2%84%E6%B8%B2%E6%9F%93%E6%A0%B7%E5%BC%8F" data-v-bc1541f8=""></a></h3><p data-v-bc1541f8="">这里的多页面指的是前端路由的多页面，都在一个 React 单页应用的范围内。在此基础上要实现这个效果稍微复杂一些。</p><p data-v-bc1541f8="">首先介绍一下 URL 中 Hash 作用。<code data-v-bc1541f8="">#</code> 代表网页中的一个位置，其右面的字符，就是该位置的标识符。浏览器读取这个 URL 后，会自动将 Hash 标注的内容位置滚动至可视区域。<code data-v-bc1541f8="">#</code> 是用来指导浏览器动作的，浏览器发出的 HTTP 请求中不包括 <code data-v-bc1541f8="">#</code>，所以 Hash 对服务器端完全无用。</p><p data-v-bc1541f8="">之后再来看 Hash 模式的前端路由：</p><pre class="shiki shiki-themes min-light night-owl" style="--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627;" tabindex="0" data-v-bc1541f8=""><code data-v-bc1541f8=""><span class="line" data-v-bc1541f8=""><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8="">const</span><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> url1</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8=""> =</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8=""> '</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">http://example.com/project/#/page1</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span></span>
<span class="line" data-v-bc1541f8=""></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8="">const</span><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> url2</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8=""> =</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8=""> '</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">http://example.com/project/#/page2</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span></span>
<span class="line" data-v-bc1541f8=""></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8="">const</span><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> url3</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8=""> =</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8=""> '</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">http://example.com/project/#/page1/subpage2</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span></span>
<span class="line" data-v-bc1541f8=""></span></code></pre><p data-v-bc1541f8="">访问上述任意 URL，实际上浏览器发出的请求都是<code data-v-bc1541f8="">http://example.com/project/</code>，服务端就会返回<code data-v-bc1541f8="">http://example.com/project/index.html</code>。之后，代码执行，路由框架匹配前端路由，最终渲染出对应页面。</p><p data-v-bc1541f8="">对此，实现目的，有三种想法：</p><ol data-v-bc1541f8=""><li data-v-bc1541f8="">将多种预渲染样式整合在 HTML 中，使用 JS 匹配前端路由决定需要显示的样式；</li><li data-v-bc1541f8="">每一个页面单独写成一个 React 单页模块；</li><li data-v-bc1541f8="">想办法实现不同的路由返回不同的 HTML 文档。</li></ol><p data-v-bc1541f8="">下面主要介绍方式 3.</p><p data-v-bc1541f8="">想要根据不同的路由返回对应不同的 HTML 文档</p><h4 id="step%201" data-v-bc1541f8="">step 1<a name="step%201" class="headerlink" href="#step%201" data-v-bc1541f8=""></a></h4><p data-v-bc1541f8="">第一步要改变前端路由方式（Hash =&gt; Browser）。</p><pre class="shiki shiki-themes min-light night-owl" style="--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627;" tabindex="0" data-v-bc1541f8=""><code data-v-bc1541f8=""><span class="line" data-v-bc1541f8=""><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic;" data-v-bc1541f8="">// Browser 模式下的 URL 以及服务端返回的内容</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8="">const</span><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> url1</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8=""> =</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8=""> '</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">http://example.com/project/page1</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic;" data-v-bc1541f8="">// http://example.com/project/page1/index.html</span></span>
<span class="line" data-v-bc1541f8=""></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8="">const</span><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> url2</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8=""> =</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8=""> '</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">http://example.com/project/page2</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic;" data-v-bc1541f8="">// http://example.com/project/page2/index.html</span></span>
<span class="line" data-v-bc1541f8=""></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8="">const</span><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> url3</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8=""> =</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8=""> '</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">http://example.com/project/page1/subpage2</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic;" data-v-bc1541f8="">// http://example.com/project/page1/subpage2/index.html</span></span>
<span class="line" data-v-bc1541f8=""></span></code></pre><h4 id="step%202" data-v-bc1541f8="">step 2<a name="step%202" class="headerlink" href="#step%202" data-v-bc1541f8=""></a></h4><p data-v-bc1541f8="">第二步，在服务器的对应目录下提供对应的 HTML 文档。 但很多时候我们并没有需求为每个路由页面提供 HTML 文档，这时候去访问一个前端路由而后端没提供文档时会出现 404，这不是我们想要看到的。因为这个路由页面是由前端渲染、在前端是存在的。 这时候就要做一个处理，就是常说的 Nginx 重定向（以 Nginx 为例），表示该路由后端处理不了，交给前端处理。</p><pre class="shiki shiki-themes min-light night-owl" style="--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627;" tabindex="0" data-v-bc1541f8=""><code data-v-bc1541f8=""><span class="line" data-v-bc1541f8=""><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8="">location</span><span style="--shiki-light:#2B5581;--shiki-dark:#ECC48D;" data-v-bc1541f8=""> /project</span><span style="--shiki-light:#2B5581;--shiki-dark:#ECC48D;" data-v-bc1541f8=""> {</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8="">  try_files</span><span style="--shiki-light:#24292EFF;--shiki-dark:#C5E478;" data-v-bc1541f8=""> $uri</span><span style="--shiki-light:#24292EFF;--shiki-dark:#C5E478;" data-v-bc1541f8=""> $uri</span><span style="--shiki-light:#2B5581;--shiki-dark:#ECC48D;" data-v-bc1541f8="">/</span><span style="--shiki-light:#2B5581;--shiki-dark:#ECC48D;" data-v-bc1541f8=""> index.html</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">;</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">}</span></span></code></pre><p data-v-bc1541f8=""><img alt="5c224d3bc4ff9e2b4d69960f" loading="lazy" title="5c224d3bc4ff9e2b4d69960f" class="post-image" src="https://www.superbed.cn/pic/5c224d3bc4ff9e2b4d69960f" onerror="this.onerror=null;this.src='/images/image-error.jpg';" data-v-bc1541f8=""></p><h4 id="step%203" data-v-bc1541f8="">step 3<a name="step%203" class="headerlink" href="#step%203" data-v-bc1541f8=""></a></h4><p data-v-bc1541f8="">第三步，开发时应该怎么处理？总不能手动写好这些 HTML 文档再上传到服务器。介绍两种方式，都是基于 Webpack 进行打包生成：</p><h5 id="3.1" data-v-bc1541f8="">3.1<a name="3.1" class="headerlink" href="#3.1" data-v-bc1541f8=""></a></h5><p data-v-bc1541f8="">使用多个 <a href="https://github.com/jantimon/html-webpack-plugin" target="_blank" class="" data-v-bc1541f8=""><!--[-->html-webpack-plugin<!--]--></a>，因为我们的项目分为了多个 React 项目，每个项目的页面不会很多，因此使用多个 <code data-v-bc1541f8="">html-webpack-plugin</code> 没有打包性能的问题。</p><pre class="shiki shiki-themes min-light night-owl" style="--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627;" tabindex="0" data-v-bc1541f8=""><code data-v-bc1541f8=""><span class="line" data-v-bc1541f8=""><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8="">const</span><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> routesCfg</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8=""> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8=""> [</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">  {</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#D6DEEB;--shiki-dark-font-style:italic;" data-v-bc1541f8="">    path</span><span style="--shiki-light:#D32F2F;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">:</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8=""> '</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">/user</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span><span style="--shiki-light:#212121;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">,</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#D6DEEB;--shiki-dark-font-style:italic;" data-v-bc1541f8="">    template</span><span style="--shiki-light:#D32F2F;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">:</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8=""> '</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">./documents/user.html</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">  }</span><span style="--shiki-light:#212121;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">,</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">  {</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#D6DEEB;--shiki-dark-font-style:italic;" data-v-bc1541f8="">    path</span><span style="--shiki-light:#D32F2F;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">:</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8=""> '</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">/user/profile</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span><span style="--shiki-light:#212121;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">,</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#D6DEEB;--shiki-dark-font-style:italic;" data-v-bc1541f8="">    template</span><span style="--shiki-light:#D32F2F;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">:</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8=""> '</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">./documents/user.html</span><span style="--shiki-light:#22863A;--shiki-dark:#D9F5DD;" data-v-bc1541f8="">'</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">  }</span><span style="--shiki-light:#212121;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">,</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">]</span></span>
<span class="line" data-v-bc1541f8=""></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#7FDBCA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">routesCfg</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">.</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8="">forEach</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D7DBE0;" data-v-bc1541f8="">r</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C792EA;" data-v-bc1541f8=""> =&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8=""> {</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#7FDBCA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">  webpackConfig</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">.</span><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#FAF39F;--shiki-dark-font-style:italic;" data-v-bc1541f8="">plugins</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">.</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8="">push</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">(</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#D32F2F;--shiki-dark:#7FDBCA;" data-v-bc1541f8="">    new</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> HtmlWebpackPlugin</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">({</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">      filename</span><span style="--shiki-light:#D32F2F;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">:</span><span style="--shiki-light:#22863A;--shiki-dark:#D6DEEB;" data-v-bc1541f8=""> `</span><span style="--shiki-light:#D32F2F;--shiki-dark:#D3423E;" data-v-bc1541f8="">${</span><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#7FDBCA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">r</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">.</span><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#FAF39F;--shiki-dark-font-style:italic;" data-v-bc1541f8="">path</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">.</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8="">replace</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">(</span><span style="--shiki-light:#22863A;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">/</span><span style="--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">^</span><span style="--shiki-light:#22863A;--shiki-dark:#F78C6C;" data-v-bc1541f8="">\/</span><span style="--shiki-light:#22863A;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">/</span><span style="--shiki-light:#212121;--shiki-dark:#D3423E;" data-v-bc1541f8="">,</span><span style="--shiki-light:#22863A;--shiki-dark:#D6DEEB;" data-v-bc1541f8=""> ''</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">)</span><span style="--shiki-light:#D32F2F;--shiki-dark:#D3423E;" data-v-bc1541f8="">}</span><span style="--shiki-light:#22863A;--shiki-dark:#ECC48D;" data-v-bc1541f8="">/index.html</span><span style="--shiki-light:#22863A;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">`</span><span style="--shiki-light:#212121;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">,</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">      template</span><span style="--shiki-light:#D32F2F;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">:</span><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#7FDBCA;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> path</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">.</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic;" data-v-bc1541f8="">join</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D7DBE0;" data-v-bc1541f8="">__dirname</span><span style="--shiki-light:#212121;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">,</span><span style="--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#7FDBCA;--shiki-dark-font-style:italic;" data-v-bc1541f8=""> r</span><span style="--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;" data-v-bc1541f8="">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#BAEBE2;" data-v-bc1541f8="">template</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">)</span><span style="--shiki-light:#212121;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">,</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">    })</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">  )</span></span>
<span class="line" data-v-bc1541f8=""><span style="--shiki-light:#24292EFF;--shiki-dark:#D6DEEB;" data-v-bc1541f8="">})</span></span></code></pre><p data-v-bc1541f8=""><img alt="5c224d3bc4ff9e2b4d699610" loading="lazy" title="5c224d3bc4ff9e2b4d699610" class="post-image" src="https://www.superbed.cn/pic/5c224d3bc4ff9e2b4d699610" onerror="this.onerror=null;this.src='/images/image-error.jpg';" data-v-bc1541f8=""></p><p data-v-bc1541f8="">该方式需要手动编写预渲染的内容，但能做到精细的控制。</p><p data-v-bc1541f8="">另外，有个小问题：如果 publicPath 是相对路径的话，打包结果子目录下的资源引用的路径会有问题。</p><h5 id="3.2" data-v-bc1541f8="">3.2<a name="3.2" class="headerlink" href="#3.2" data-v-bc1541f8=""></a></h5><p data-v-bc1541f8="">使用 <a href="https://github.com/chrisvfritz/prerender-spa-plugin" target="_blank" class="" data-v-bc1541f8=""><!--[-->prerender-spa-plugin<!--]--></a>。提供配置，打包完成后会启动一个本地服务，使用无头浏览器（puppeteer）访问传入配置中的路径，接着抽取页面的文档内容，重新生成新的 HTML 文件。</p><p data-v-bc1541f8="">该方式生成的预渲染内容是页面最终的样式，适合一些静态类型页面的显示，切忌用于生成动态内容的预渲染（比如用户个人信息页面，你肯定不希望打开页面时先显示的是其他人的信息再变成自己的，这个其他人的信息就是在抽取页面内容的时候注入的）。</p><p data-v-bc1541f8="">当使用 CDN 的时候需要注意了，该插件启动本地服务访问页面时，资源是还没上传至 CDN 的（这还属于 Webpack 的打包流程，一般是在打包流程结束后进行 CDN 上传）。</p><p data-v-bc1541f8="">此处提供两个思路解决该问题：</p><ol data-v-bc1541f8=""><li data-v-bc1541f8="">定制个 Webpack 插件，在该插件前生效，将文件提前上传至 CDN。不要忘了，打包结束后还需要再次上传。</li><li data-v-bc1541f8="">实现请求拦截，将访问 CDN 的请求劫持到本地相对目录的文件。但是该插件没有暴露 puppeteer 的对象，实现起来会比较困难。</li></ol><h2 id="%E5%85%B6%E4%BB%96%E6%96%B9%E9%9D%A2" data-v-bc1541f8="">其他方面<a name="%E5%85%B6%E4%BB%96%E6%96%B9%E9%9D%A2" class="headerlink" href="#%E5%85%B6%E4%BB%96%E6%96%B9%E9%9D%A2" data-v-bc1541f8=""></a></h2><ol data-v-bc1541f8=""><li data-v-bc1541f8="">开启 CDN ，加速资源的网络传输；</li><li data-v-bc1541f8="">首屏列表类页面应控制渲染数量，避免生成用不到（用户还不可见）的节点（有时也会需要预先加载，视具体情况而定）；</li><li data-v-bc1541f8="">条件允许时，使用图片服务辅助前端的图片显示，做到格式、尺寸、品质的控制；</li><li data-v-bc1541f8="">设置资源返回的请求头字段，如 cache-control、expires 等，做到资源缓存，加快二次访问；</li><li data-v-bc1541f8="">考虑 Service Worker 缓存技术的使用</li><li data-v-bc1541f8="">...</li></ol><p data-v-bc1541f8="">以上，是新人对页面加载优化的探索，实际上一定还存在不少可优化、提升用户体验的点，接下来还需要更多的实践。</p><hr data-v-bc1541f8=""><p data-v-bc1541f8="">参考链接 &amp; 相关阅读:</p><ul data-v-bc1541f8=""><li data-v-bc1541f8=""><a href="https://zhuanlan.zhihu.com/p/37148975" target="_blank" class="" data-v-bc1541f8=""><!--[-->React 16 加载性能优化指南<!--]--></a></li><li data-v-bc1541f8=""><a href="https://polyfill.io/v2/docs/" target="_blank" class="" data-v-bc1541f8=""><!--[-->polyfill 按需返回<!--]--></a></li><li data-v-bc1541f8=""><a href="https://segmentfault.com/a/1190000012794598" target="_blank" class="" data-v-bc1541f8=""><!--[-->你的 Tree-Shaking 并没什么卵用<!--]--></a></li><li data-v-bc1541f8=""><a href="https://juejin.im/post/5a4dc842518825698e7279a9" target="_blank" class="" data-v-bc1541f8=""><!--[-->Tree-Shaking 性能优化实践 - 原理篇<!--]--></a></li><li data-v-bc1541f8=""><a href="https://juejin.im/post/5a4ed917f265da3e317df515" target="_blank" class="" data-v-bc1541f8=""><!--[-->浏览器页面资源加载过程与优化<!--]--></a></li><li data-v-bc1541f8=""><a href="https://juejin.im/entry/598080226fb9a03c5d535cd5" target="_blank" class="" data-v-bc1541f8=""><!--[-->Chrome 中的 First Meaningful Paint<!--]--></a></li><li data-v-bc1541f8=""><a href="https://developers.google.com/web/fundamentals/performance/critical-rendering-path/" target="_blank" class="" data-v-bc1541f8=""><!--[-->关键渲染路径<!--]--></a></li><li data-v-bc1541f8=""><a href="https://juejin.im/entry/5a111eb7f265da431c6fe51c" target="_blank" class="" data-v-bc1541f8=""><!--[-->服务端渲染 vs 客户端渲染<!--]--></a></li><li data-v-bc1541f8=""><a href="https://tech.meituan.com/first_contentful_paint_practice.html" target="_blank" class="" data-v-bc1541f8=""><!--[-->构建时预渲染：网页首帧优化实践<!--]--></a></li><li data-v-bc1541f8=""><a href="http://taobaofed.org/blog/2016/04/06/optimize-in-tbhome/" target="_blank" class="" data-v-bc1541f8=""><!--[-->淘宝首页性能优化实践<!--]--></a></li><li data-v-bc1541f8=""><a href="https://github.com/camsong/blog/issues/8" target="_blank" class="" data-v-bc1541f8=""><!--[-->精读前后端渲染之争<!--]--></a></li><li data-v-bc1541f8=""><a href="http://www.ruanyifeng.com/blog/2011/03/url_hash.html" target="_blank" class="" data-v-bc1541f8=""><!--[-->URL 的井号<!--]--></a></li></ul><!--]--></div></article><aside class="pointer-events-none fixed z-20 top-0 w-full h-full left-0 overscroll-contain transition-300 lg:pointer-events-auto lg:absolute lg:w-auto lg:bg-transparent lg:left-[calc(100%+clamp(6px,17.1875vw-176px,50px))]" data-v-bc1541f8=""><nav class="overflow-y-auto text-foreground overscroll-contain bg-background w-74 max-w-4/5 h-full py-8 px-6 rounded-tl-xl rounded-bl-xl absolute top-0 transition-300 right-0 translate-x-full lg:p-0 lg:max-w-44 xl:max-w-50 lg:h-auto lg:max-h-[calc(100vh-130px)] lg:rounded-none lg:sticky lg:top-10 lg:right-auto lg:translate-x-0 lg:bg-transparent lg:ml-0" data-v-bc1541f8=""><h2 class="mb-2 font-bold lg:hidden" data-v-bc1541f8="">TABLE OF CONTENTS</h2><ul class="group/root" data-v-bc1541f8=""><!--[--><li><a href="#%E4%B8%80%E6%AC%A1%E9%A1%B5%E9%9D%A2%EF%BC%88SPA%EF%BC%89%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:20px;margin-right:8px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="一次页面（SPA）加载过程">一次页面（SPA）加载过程</span></a><!----></li><li><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:20px;margin-right:8px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="优化方向">优化方向</span></a><!----></li><li><a href="#%E5%87%8F%E5%B0%8F%E8%B5%84%E6%BA%90%E5%A4%A7%E5%B0%8F" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:20px;margin-right:8px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="减小资源大小">减小资源大小</span></a><ul class=""><!--[--><li><a href="#%E4%BB%A3%E7%A0%81%E6%8B%86%E5%88%86%E3%80%81%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:16px;margin-right:12px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="代码拆分、动态加载">代码拆分、动态加载</span></a><!----></li><li><a href="#%E5%87%8F%E5%B0%91%E4%BB%A3%E7%A0%81%E4%BD%93%E7%A7%AF" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:16px;margin-right:12px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="减少代码体积">减少代码体积</span></a><!----></li><!--]--></ul></li><li><a href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:20px;margin-right:8px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="浏览器资源加载优化">浏览器资源加载优化</span></a><ul class=""><!--[--><li><a href="#%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%85%B3%E9%94%AE%E8%AF%B7%E6%B1%82%E9%93%BE" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:16px;margin-right:12px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="动态加载与关键请求链">动态加载与关键请求链</span></a><!----></li><li><a href="#%E5%BB%B6%E8%BF%9F%E9%9D%9E%E5%85%B3%E9%94%AE%E8%B5%84%E6%BA%90" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:16px;margin-right:12px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="延迟非关键资源">延迟非关键资源</span></a><!----></li><li><a href="#%E5%87%8F%E5%B0%91%E8%AF%B7%E6%B1%82" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:16px;margin-right:12px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="减少请求">减少请求</span></a><!----></li><!--]--></ul></li><li><a href="#%E9%A6%96%E5%B1%8F%E7%A9%BA%E7%99%BD%E4%BC%98%E5%8C%96" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:20px;margin-right:8px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="首屏空白优化">首屏空白优化</span></a><ul class=""><!--[--><li><a href="#%E9%80%9A%E7%94%A8%20Loading%20%E6%A0%B7%E5%BC%8F" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:16px;margin-right:12px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="通用 Loading 样式">通用 Loading 样式</span></a><!----></li><li><a href="#%E5%A4%9A%E9%A1%B5%E9%9D%A2%E5%AE%9A%E5%88%B6%E7%9A%84%E9%A2%84%E6%B8%B2%E6%9F%93%E6%A0%B7%E5%BC%8F" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:16px;margin-right:12px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="多页面定制的预渲染样式">多页面定制的预渲染样式</span></a><ul class=""><!--[--><li><a href="#step%201" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:12px;margin-right:16px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="step 1">step 1</span></a><!----></li><li><a href="#step%202" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:12px;margin-right:16px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="step 2">step 2</span></a><!----></li><li><a href="#step%203" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:12px;margin-right:16px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="step 3">step 3</span></a><ul class=""><!--[--><li><a href="#3.1" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:8px;margin-right:20px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="3.1">3.1</span></a><!----></li><li><a href="#3.2" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:8px;margin-right:20px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="3.2">3.2</span></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul></li><li><a href="#%E5%85%B6%E4%BB%96%E6%96%B9%E9%9D%A2" class="group/item text-foreground flex flex-nowrap items-center mb-1.5"><span class="hidden lg:block h-1 bg-foreground rounded-sm opacity-30 transition-300 shrink-0 group-hover/item:opacity-85" style="width:20px;margin-right:8px;"></span><span class="opacity-100 text-[color-mix(in_srgb,var(--foreground)_70%,transparent)] text-sm overflow-hidden text-ellipsis whitespace-nowrap transition-300 max-w-full flex-grow lg:opacity-0 lg:max-w-46 group-hover/root:opacity-100 group-hover/item:text-foreground lg:opacity-0" title="其他方面">其他方面</span></a><!----></li><!--]--></ul></nav></aside></div><hr class="border-border mt-10" data-v-bc1541f8=""><div class="mt-10" data-v-bc1541f8=""><div data-v-bc1541f8=""><h2 class="text-xl font-bold mb-5"><a href="#comment" class="text-accent foreground-link">留言板</a></h2><div class="utterances-wrapper"></div></div></div><!--]--></main><footer class="text-center py-6 text-gray-500 dark:text-gray-400 text-sm"><div><span>© 2017-2025 Daief's Blog</span></div></footer><div></div></div><!--]--></div>
<script>window.__INITIAL_STATE__="{\"naiveUiStyles\":\"\"}"</script>
  

</body></html>